<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>e:\users\funfine\source\quiz\quiz\quizwebhookbot\services\updateservice.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using Microsoft.Extensions.Logging;
using QuizBotCore;
using QuizBotCore.Commands;
using QuizBotCore.Database;
using QuizBotCore.Parser;
using QuizBotCore.States;
using QuizBotCore.Transitions;
using QuizRequestService;
using Telegram.Bot.Types;
using Telegram.Bot.Types.Enums;

namespace QuizWebHookBot.Services
{
    public class UpdateService : IUpdateService
    {
        private readonly ILogger&lt;UpdateService&gt; logger;
        private readonly IMessageParser parser;
        private readonly IStateMachine&lt;ICommand&gt; stateMachine;
        private readonly IQuizService quizService;
        private readonly IUserRepository userRepository;

        public UpdateService(
            ILogger&lt;UpdateService&gt; logger,
            IUserRepository userRepository,
            IMessageParser parser,
            IStateMachine&lt;ICommand&gt; stateMachine,
            IQuizService quizService)
        {
            this.logger = logger;
            this.userRepository = userRepository;
            this.parser = parser;
            this.stateMachine = stateMachine;
            this.quizService = quizService;
        }

        public ICommand ProcessMessage(Update update)
        {
            long userId = -1;
            switch (update.Type)
            {
                case UpdateType.CallbackQuery:
                    userId = update.CallbackQuery.Message.Chat.Id;
                    break;
                case UpdateType.Message:
                    userId = update.Message.Chat.Id;
                    break;
            }
                        
            var userEntity = userRepository.FindByTelegramId(userId) ??
                            userRepository.Insert(new UserEntity(new UnknownUserState(), userId, Guid.NewGuid(), 0));

            var state = userEntity.CurrentState;

            var transition = parser.Parse(state, update, quizService, logger);
            logger.LogInformation($&quot;Parsed transition {transition}&quot;);
            logger.LogInformation($&quot;Parsed state {state}&quot;);
            if (transition is CorrectTransition correct)
                logger.LogInformation($&quot;State content: {correct.Content}&quot;);
            var (currentState, currentCommand) = stateMachine.GetNextState(state, transition);
            
            logger.LogInformation($&quot;New state {currentState}&quot;);

            userRepository.Update(new UserEntity(currentState, userId, userEntity.Id, userEntity.MessageId));

            return currentCommand;
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[23,9,28,38,0],[29,9,29,10,0],[30,13,30,34,0],[31,13,31,50,0],[32,13,32,34,0],[33,13,33,46,0],[34,13,34,44,0],[35,9,35,10,0],[38,9,38,10,0],[39,13,39,30,0],[40,13,40,33,0],[43,21,43,67,0],[44,21,44,27,0],[46,21,46,53,0],[47,21,47,27,0],[50,13,51,118,0],[53,13,53,49,0],[55,13,55,79,0],[56,13,56,70,0],[57,13,57,60,0],[58,13,58,57,0],[59,17,59,76,0],[60,13,60,95,0],[62,13,62,64,0],[64,13,64,110,0],[66,13,66,35,0],[67,9,67,10,0]]);
    </script>
  </body>
</html>