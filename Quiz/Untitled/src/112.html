<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>e:\users\funfine\source\quiz\quiz\database\quizservice\mongotaskrepository.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using Application.Repositories;
using Domain.Entities;
using Domain.Entities.TaskGenerators;
using MongoDB.Driver;

namespace DataBase
{
    public class MongoTaskRepository : ITaskRepository
    {
        private const string CollectionName = &quot;Tasks&quot;;
        private readonly IMongoCollection&lt;Topic&gt; topicCollection;

        public MongoTaskRepository(IMongoDatabase database)
        {
            topicCollection = database.GetCollection&lt;Topic&gt;(CollectionName);
        }

        public Topic[] GetTopics()
        {
            return topicCollection.Find(t =&gt; true).ToList().ToArray();
        }

        /// &lt;inheritdoc /&gt;
        public Level[] GetNextLevels(Guid topicId, Guid levelId)
        {
            var topic = topicCollection
                .Find(t =&gt; t.Id == topicId)
                .FirstOrDefault();
            var levels = topic
                             ?.Levels
                             ?.FirstOrDefault(l =&gt; l.Id == levelId)
                             ?.NextLevels
                         ?? new Guid[0];
            return topic
                ?.Levels
                ?.Where(l =&gt; levels.Contains(l.Id))
                .ToArray();
        }

        /// &lt;inheritdoc /&gt;
        public Level[] GetLevelsFromTopic(Guid topicId)
        {
            var topic = topicCollection.Find(t =&gt; t.Id == topicId).FirstOrDefault();
            return topic?.Levels;
        }

        /// &lt;inheritdoc /&gt;
        public TaskGenerator[] GetGeneratorsFromLevel(Guid topicId, Guid levelId)
        {
            var topic = topicCollection.Find(t =&gt; t.Id == topicId).FirstOrDefault();
            var level = topic?.Levels?.Where(l =&gt; l.Id == levelId).FirstOrDefault();
            return level?.Generators;
        }

        /// &lt;inheritdoc /&gt;
        public Topic InsertTopic(Topic topic)
        {
            topicCollection.InsertOne(topic);
            return topic;
        }

        /// &lt;inheritdoc /&gt;
        public void UpdateTopic(Topic topic)
        {
            topicCollection.ReplaceOne(t =&gt; t.Id == topic.Id, topic);
        }

        /// &lt;inheritdoc /&gt;
        public Topic FindTopic(Guid topicId)
        {
            return topicCollection.Find(t =&gt; t.Id == topicId).FirstOrDefault();
        }

        /// &lt;inheritdoc /&gt;
        public Level InsertLevel(Guid topicId, Level level)
        {
            var topic = topicCollection.Find(t =&gt; t.Id == topicId).FirstOrDefault();
            var levels = topic?.Levels?.Append(level);
            var newTopic = topic.With(levels: levels.ToArray());
            UpdateTopic(newTopic);
            return level;
        }

        /// &lt;inheritdoc /&gt;
        public Level UpdateLevel(Guid topicId, Level level)
        {
            var topic = topicCollection.Find(t =&gt; t.Id == topicId).FirstOrDefault();
            var levels = topic?.Levels?.ToList();
            var index = levels?.FindIndex(l =&gt; l.Id == level.Id) ?? -1;
            if (index != -1 &amp;&amp; levels != null)
            {
                levels[index] = level;
                var newTopic = topic.With(levels: levels.ToArray());
                UpdateTopic(newTopic);
            }
            return level;
        }

        /// &lt;inheritdoc /&gt;
        public Level FindLevel(Guid topicId, Guid levelId)
        {
            var topic = topicCollection.Find(t =&gt; t.Id == topicId).FirstOrDefault();
            return topic?.Levels?.Where(l =&gt; l.Id == levelId).FirstOrDefault();
        }

        /// &lt;inheritdoc /&gt;
        public TaskGenerator InsertGenerator(Guid topicId, Guid levelId, TaskGenerator generator)
        {
            var topic = topicCollection.Find(t =&gt; t.Id == topicId).FirstOrDefault();
            var levels = topic?.Levels?.ToList();
            var index = levels?.FindIndex(l =&gt; l.Id == levelId) ?? -1;
            if (index != -1 &amp;&amp; levels != null)
            {
                var level = levels[index];
                var generators = level.Generators.Append(generator);
                var newLevel = level.With(generators: generators.ToArray());
                levels[index] = newLevel;
                var newTopic = topic.With(levels: levels.ToArray());
                UpdateTopic(newTopic);
            }
            return generator;
        }

        public ICollection&lt;TaskGenerator&gt; InsertGenerators(
            Guid topicId,
            Guid levelId,
            ICollection&lt;TaskGenerator&gt; generators)
        {
            var topic = topicCollection.Find(t =&gt; t.Id == topicId).FirstOrDefault();
            var levels = topic?.Levels?.ToList();
            var index = levels?.FindIndex(l =&gt; l.Id == levelId) ?? -1;
            if (index != -1 &amp;&amp; levels != null)
            {
                var level = levels[index];
                var levelGenerators = level.Generators.ToList();
                levelGenerators.AddRange(generators);
                var newLevel = level.With(generators: levelGenerators.ToArray());
                levels[index] = newLevel;
                var newTopic = topic.With(levels: levels.ToArray());
                UpdateTopic(newTopic);
            }
            return generators;
        }

        /// &lt;inheritdoc /&gt;
        public TaskGenerator UpdateGenerator(Guid topicId, Guid levelId, TaskGenerator generator)
        {
            var topic = topicCollection.Find(t =&gt; t.Id == topicId).FirstOrDefault();
            var levels = topic?.Levels?.ToList();
            var index = levels?.FindIndex(l =&gt; l.Id == levelId) ?? -1;
            if (index != -1 &amp;&amp; levels != null)
            {
                var level = levels[index];
                var generators = level.Generators;
                var genIndex = level.Generators.ToList().FindIndex(l =&gt; l.Id == generator.Id);
                generators[genIndex] = generator;
                var newLevel = level.With(generators: generators.ToArray());
                levels[index] = newLevel;
                var newTopic = topic.With(levels: levels.ToArray());
                UpdateTopic(newTopic);
            }
            return generator;
        }

        /// &lt;inheritdoc /&gt;
        public TaskGenerator FindGenerator(Guid topicId, Guid levelId, Guid generatorId)
        {
            var topic = topicCollection.Find(t =&gt; t.Id == topicId).FirstOrDefault();
            var levels = topic?.Levels?.ToList();
            var level = levels?.FirstOrDefault(l =&gt; l.Id == levelId);
            var generator = level?.Generators.FirstOrDefault(l =&gt; l.Id == generatorId);
            return generator;
        }

        public void DeleteTopic(Guid topicId)
        {
            topicCollection.DeleteOne(topic =&gt; topic.Id == topicId);
        }

        public void DeleteLevel(Guid topicId, Guid levelId)
        {
            var topic = FindTopic(topicId);
            var levels = topic
                .Levels
                .Where(level =&gt; level.Id != levelId)
                .ToArray();
            UpdateTopic(topic.With(levels: levels));
        }

        public void DeleteGenerator(Guid topicId, Guid levelId, Guid generatorId)
        {
            var level = FindLevel(topicId, levelId);
            var generators = level
                .Generators
                .Where(generator =&gt; generator.Id != generatorId)
                .ToArray();
            UpdateLevel(topicId, level.With(generators: generators));
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[16,9,16,60,0],[17,9,17,10,0],[18,13,18,77,0],[19,9,19,10,0],[22,9,22,10,0],[23,13,23,71,0],[24,9,24,10,0],[28,9,28,10,0],[29,13,31,35,0],[32,13,34,52,0],[34,52,34,67,0],[34,67,36,41,0],[32,13,36,41,0],[37,13,39,30,0],[39,30,39,51,0],[39,51,40,28,0],[37,13,40,28,0],[41,9,41,10,0],[45,9,45,10,0],[46,13,46,85,0],[47,13,47,34,0],[48,9,48,10,0],[52,9,52,10,0],[53,13,53,85,0],[54,13,54,51,0],[54,51,54,66,0],[54,66,54,85,0],[54,13,54,85,0],[55,13,55,38,0],[56,9,56,10,0],[60,9,60,10,0],[61,13,61,46,0],[62,13,62,26,0],[63,9,63,10,0],[67,9,67,10,0],[68,13,68,70,0],[69,9,69,10,0],[73,9,73,10,0],[74,13,74,80,0],[75,9,75,10,0],[79,9,79,10,0],[80,13,80,85,0],[81,13,81,55,0],[82,13,82,65,0],[83,13,83,35,0],[84,13,84,26,0],[85,9,85,10,0],[89,9,89,10,0],[90,13,90,85,0],[91,13,91,50,0],[92,13,92,48,0],[92,48,92,64,0],[92,64,92,72,0],[92,13,92,72,0],[93,13,93,47,0],[94,13,94,14,0],[95,17,95,39,0],[96,17,96,69,0],[97,17,97,39,0],[98,13,98,14,0],[99,13,99,26,0],[100,9,100,10,0],[104,9,104,10,0],[105,13,105,85,0],[106,13,106,46,0],[106,46,106,61,0],[106,61,106,80,0],[106,13,106,80,0],[107,9,107,10,0],[111,9,111,10,0],[112,13,112,85,0],[113,13,113,50,0],[114,13,114,48,0],[114,48,114,63,0],[114,63,114,71,0],[114,13,114,71,0],[115,13,115,47,0],[116,13,116,14,0],[117,17,117,43,0],[118,17,118,69,0],[119,17,119,77,0],[120,17,120,42,0],[121,17,121,69,0],[122,17,122,39,0],[123,13,123,14,0],[124,13,124,30,0],[125,9,125,10,0],[131,9,131,10,0],[132,13,132,85,0],[133,13,133,50,0],[134,13,134,48,0],[134,48,134,63,0],[134,63,134,71,0],[134,13,134,71,0],[135,13,135,47,0],[136,13,136,14,0],[137,17,137,43,0],[138,17,138,65,0],[139,17,139,54,0],[140,17,140,82,0],[141,17,141,42,0],[142,17,142,69,0],[143,17,143,39,0],[144,13,144,14,0],[145,13,145,31,0],[146,9,146,10,0],[150,9,150,10,0],[151,13,151,85,0],[152,13,152,50,0],[153,13,153,48,0],[153,48,153,63,0],[153,63,153,71,0],[153,13,153,71,0],[154,13,154,47,0],[155,13,155,14,0],[156,17,156,43,0],[157,17,157,51,0],[158,17,158,73,0],[158,73,158,93,0],[158,93,158,95,0],[158,17,158,95,0],[159,17,159,50,0],[160,17,160,77,0],[161,17,161,42,0],[162,17,162,69,0],[163,17,163,39,0],[164,13,164,14,0],[165,13,165,30,0],[166,9,166,10,0],[170,9,170,10,0],[171,13,171,85,0],[172,13,172,50,0],[173,13,173,53,0],[173,53,173,68,0],[173,68,173,70,0],[173,13,173,70,0],[174,13,174,67,0],[174,67,174,86,0],[174,86,174,88,0],[174,13,174,88,0],[175,13,175,30,0],[176,9,176,10,0],[179,9,179,10,0],[180,13,180,69,0],[181,9,181,10,0],[184,9,184,10,0],[185,13,185,44,0],[186,13,188,33,0],[188,33,188,52,0],[188,52,189,28,0],[186,13,189,28,0],[190,13,190,53,0],[191,9,191,10,0],[194,9,194,10,0],[195,13,195,53,0],[196,13,198,37,0],[198,37,198,64,0],[198,64,199,28,0],[196,13,199,28,0],[200,13,200,70,0],[201,9,201,10,0]]);
    </script>
  </body>
</html>