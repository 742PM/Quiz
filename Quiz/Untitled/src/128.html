<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>e:\users\funfine\source\quiz\quiz\quizrequestextendedservice\database\userrepository.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Threading.Tasks;
using DataBase;
using Infrastructure.Extensions;
using Infrastructure.Result;
using MongoDB.Driver;
using static Infrastructure.Result.None;

namespace QuizRequestExtendedService.Database
{
    public class UserRepository&lt;TToken, TAuth&gt; : IUserRepository&lt;TToken, TAuth&gt;
    {
        private const string CollectionName = &quot;EditorAuth&quot;;
        private readonly IMongoCollection&lt;Container&gt; authDataCollection;
        private readonly Func&lt;TToken&gt; tokenCreator;

        static UserRepository()
        {
            MongoHelpers.AutoRegisterClassMap&lt;Container&gt;();
            MongoHelpers.AutoRegisterClassMap&lt;TAuth&gt;();
            MongoHelpers.AutoRegisterClassMap&lt;TToken&gt;();
        }

        public UserRepository(IMongoDatabase database, Func&lt;TToken&gt; tokenCreator)
        {
            this.tokenCreator = tokenCreator;
            authDataCollection = database.GetCollection&lt;Container&gt;(CollectionName);
        }

        public async Task RegisterUserAsync(TAuth data)
        {
            var token = tokenCreator();
            await authDataCollection.InsertOneAsync(new Container(token, data));
        }

        public async Task&lt;Maybe&lt;TToken&gt;&gt; AuthenticateUserAsync(TAuth data)
        {
            var result = await authDataCollection.FindAsync(ta =&gt; ta.Data.Equals(data));

            if (!await result.AnyAsync())
                return Maybe&lt;TToken&gt;.None;
            return (await result.FirstAsync()).Token.Sure();
        }

        public None RegisterUser(TAuth data)
        {
            var token = tokenCreator();
            authDataCollection.InsertOne(new Container(token, data));
            return Nothing;
        }

        public Maybe&lt;TToken&gt; AuthenticateUser(TAuth data)
        {
            var result = authDataCollection.Find(ta =&gt; ta.Data.Equals(data));

            return result.Any() ? result.First().Token.Sure() : Maybe&lt;TToken&gt;.None;
        }

        private class Container
        {
            public Container(TToken token, TAuth data)
            {
                Token = token;
                Data = data;
            }

            public TAuth Data { get; }
            public TToken Token { get; }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[18,9,18,10,0],[19,13,19,60,0],[20,13,20,56,0],[21,13,21,57,0],[22,9,22,10,0],[24,9,24,82,0],[25,9,25,10,0],[26,13,26,46,0],[27,13,27,84,0],[28,9,28,10,0],[31,9,31,10,0],[32,13,32,40,0],[33,13,33,81,0],[34,9,34,10,0],[37,9,37,10,0],[38,13,38,89,0],[40,13,40,42,0],[41,17,41,43,0],[42,13,42,61,0],[43,9,43,10,0],[46,9,46,10,0],[47,13,47,40,0],[48,13,48,70,0],[49,13,49,28,0],[50,9,50,10,0],[53,9,53,10,0],[54,13,54,78,0],[56,13,56,84,0],[57,9,57,10,0],[61,13,61,55,0],[62,13,62,14,0],[63,17,63,31,0],[64,17,64,29,0],[65,13,65,14,0],[67,33,67,37,0],[68,35,68,39,0]]);
    </script>
  </body>
</html>