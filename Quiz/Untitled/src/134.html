<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>e:\users\funfine\source\quiz\quiz\domain\entities\taskgenerators\templatelanguagesettings.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using Infrastructure.Extensions;
using Scriban.Runtime;
using static System.Linq.Enumerable;

namespace Domain.Entities.TaskGenerators
{
    public partial class TemplateLanguage
    {
        [ScriptMemberIgnore] public const string LoopVariable = &quot;loop_var&quot;;

        [ScriptMemberIgnore] public const string Const = &quot;const&quot;;

        [ScriptMemberIgnore] public const string From = &quot;from&quot;;

        [ScriptMemberIgnore] public const string To = &quot;to&quot;;

        [ScriptMemberIgnore] public const string SimpleOperation = &quot;simple_operation&quot;;

        [ScriptMemberIgnore] public const string IterateConstant = &quot;iter&quot;;

        [ScriptMemberIgnore] public const int LoopAmount = 8;

        public const int MaxRandom = 50;

        [ScriptMemberIgnore] public const int BaseTemplateKeywordsAmount = 5;

        private static readonly Dictionary&lt;string, Func&lt;Random, string&gt;&gt; NumericalSubstitutions =
            new Dictionary&lt;string, Func&lt;Random, string&gt;&gt;
            {
                [Const] = random =&gt; AnyOf(random,
                    new ScriptArray(Range(-MaxRandom, MaxRandom).Where(x =&gt; x != 0))).ToString(),
                [From] = random =&gt; random.Next(2, MaxRandom).ToString(),
                [IterateConstant] = random =&gt; random.Next(LoopAmount &gt;&gt; 2, LoopAmount).ToString()
            };

        private static readonly Dictionary&lt;string, string[]&gt; PossibleLiteralSubstitutions =
            new Dictionary&lt;string, string[]&gt;
            {
                [LoopVariable] = new[]
                    {&quot;i&quot;, &quot;j&quot;, &quot;k&quot;, &quot;x&quot;, &quot;y&quot;, &quot;step&quot;},
                [To] = new[] {&quot;n&quot;, &quot;m&quot;, &quot;length&quot;, &quot;amount&quot;, &quot;size&quot;},
                [SimpleOperation] = new[]
                    {
                        &quot;c++&quot;, &quot;k1--&quot;, &quot;service.Update()&quot;, &quot;queue.Pop()&quot;,
                        &quot;k3++&quot;
                    }.Select(s =&gt; s + &quot;;&quot;)
                    .ToArray()
            };

        private TemplateLanguage()
        {
        }

        public static ScriptObject Create(Random random)
        {
            var language = new TemplateLanguage();
            var so = new ScriptObject();
            AddMethods(random, so);
            so.Import(language);

            var substitutionValues = GenerateLiteralSubstitutions(random)
                .Concat(NumericalSubstitutions.SelectMany(kv =&gt; Range(1, 5)
                    .Select(i =&gt; ($&quot;{kv.Key}{i}&quot;, kv.Value(random)))));

            foreach (var (substitution, value) in substitutionValues)
                so.Add(substitution, value);

            return so;
        }

        public static List&lt;SubstitutionData&gt; GetValuesExample()
        {
            return Create(new Random()).Select(kv =&gt; new SubstitutionData(kv)).ToList();
        }

        private static void AddMethod&lt;TOut, TIn&gt;(Func&lt;Random, TIn, TOut&gt; method, Random random, ScriptObject so)
        {
            so.Import(method.Method.Name.ToSnakeCase(), new Func&lt;TIn, TOut&gt;(item =&gt; method(random, item)));
        }

        private static void AddMethod&lt;TOut, TIn1, TIn2&gt;(
            Func&lt;Random, TIn1, TIn2, TOut&gt; method,
            Random random,
            ScriptObject so)
        {
            so.Import(method.Method.Name.ToSnakeCase(),
                new Func&lt;TIn1, TIn2, TOut&gt;((first, second) =&gt; method(random, first, second)));
        }
        private static void AddInstanceMethod&lt;TOut, TIn1&gt;(
            Func&lt;Random, ScriptObject, TIn1, TOut&gt; method,
            Random random,
            ScriptObject so)
        {
            so.Import(method.Method.Name.ToSnakeCase(),
                new Func&lt;TIn1, TOut&gt;(first =&gt; method(random,so ,first )));
        }

        private static IEnumerable&lt;(string, string)&gt; GenerateLiteralSubstitutions(Random random)
        {
            var takenValues = new HashSet&lt;string&gt;();
            foreach (var (substitution, values) in PossibleLiteralSubstitutions)
            {
                if (values.Length &lt; BaseTemplateKeywordsAmount)
                    throw new ArgumentException($&quot;There are not enough values to substitute every {substitution}&quot;);
                for (var i = 1; i &lt;= BaseTemplateKeywordsAmount; i++)
                {
                    var value = values.Where(v =&gt; !takenValues.Contains(v)).TakeRandomOne(random);
                    takenValues.Add(value);
                    yield return ($&quot;{substitution}{i}&quot;, value);
                }
            }
        }

        public struct SubstitutionData
        {
            public string Substitution { get; }
            public string Value { get; }

            public SubstitutionData(string substitution, object value)
            {
                Substitution = substitution;
                Value = value.ToString().Contains(&quot;GenericFunctionWrapper&quot;)
                    ? $&quot;Function {substitution}&quot;
                    : value.ToString();
            }

            public SubstitutionData(KeyValuePair&lt;string, object&gt; pair) : this(pair.Key, pair.Value)
            {
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[29,9,32,37,1],[32,37,33,77,1],[33,77,33,83,1],[33,83,33,97,1],[32,37,33,97,1],[33,97,34,36,1],[34,36,34,72,1],[34,72,35,47,1],[35,47,35,98,1],[35,98,36,15,1],[29,9,36,15,1],[38,9,48,35,1],[48,35,48,42,1],[48,42,50,15,1],[38,9,50,15,1],[52,9,52,35,1],[53,9,53,10,1],[54,9,54,10,1],[57,9,57,10,1],[58,13,58,51,1],[59,13,59,41,1],[60,13,60,36,1],[61,13,61,33,1],[63,13,64,65,1],[64,65,65,34,1],[65,34,65,68,1],[65,68,65,69,1],[64,65,65,69,1],[65,69,65,72,1],[63,13,65,72,1],[67,13,67,20,1],[67,22,67,47,1],[67,48,67,50,1],[67,51,67,69,1],[68,17,68,45,1],[70,13,70,23,1],[71,9,71,10,1],[74,9,74,10,0],[75,13,75,54,0],[75,54,75,78,0],[75,78,75,89,0],[75,13,75,89,0],[76,9,76,10,0],[79,9,79,10,1],[80,13,80,85,1],[80,85,80,105,1],[80,105,80,108,1],[80,13,80,108,1],[81,9,81,10,1],[87,9,87,10,1],[88,13,89,63,1],[89,63,89,92,1],[89,92,89,95,1],[88,13,89,95,1],[90,9,90,10,1],[95,9,95,10,1],[96,13,97,47,1],[97,47,97,72,1],[97,72,97,75,1],[96,13,97,75,1],[98,9,98,10,1],[101,9,101,10,1],[102,13,102,53,1],[103,13,103,20,1],[103,22,103,48,1],[103,49,103,51,1],[103,52,103,80,1],[104,13,104,14,1],[105,17,105,64,1],[106,21,106,116,0],[107,22,107,31,1],[107,33,107,64,1],[107,66,107,69,1],[108,17,108,18,1],[109,21,109,99,1],[109,51,109,75,1],[110,21,110,44,1],[111,21,111,64,1],[112,17,112,18,1],[113,13,113,14,1],[114,9,114,10,1],[118,42,118,46,0],[119,35,119,39,0],[122,13,122,14,0],[123,17,123,45,0],[124,17,126,40,0],[127,13,127,14,0],[129,74,129,100,0],[130,13,130,14,0],[131,13,131,14,0]]);
    </script>
  </body>
</html>