<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>e:\users\funfine\source\quiz\quiz\domain\entities\taskgenerators\templatetaskgenerator.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Linq;
using Domain.Values;
using Infrastructure;
using Infrastructure.Extensions;
using Scriban;
using Scriban.Runtime;
using static Infrastructure.Storage;

namespace Domain.Entities.TaskGenerators
{
    public class TemplateTaskGenerator : TaskGenerator
    {
        public TemplateTaskGenerator(
            Guid id,
            string[] possibleAnswers,
            string text,
            string[] hints,
            string answer,
            int streak,
            string question) :
            base(id, streak) //TODO: remove default value and fix Database.Filler
        {
            PossibleAnswers = possibleAnswers ?? throw new ArgumentException($&quot;{nameof(possibleAnswers)} are null&quot;);
            Text = text;
            Hints = hints ?? throw new ArgumentException($&quot;{nameof(hints)} are null&quot;);
            Answer = answer;
            Question = question;
        }

        [MustBeSaved] public string[] PossibleAnswers { get; }

        [MustBeSaved] public string Text { get; }

        [MustBeSaved] public string Question { get; }

        [MustBeSaved] public string[] Hints { get; }

        /// &lt;summary&gt;
        ///     Should not be used as real answer for user;
        /// &lt;/summary&gt;
        [MustBeSaved]
        public string Answer { get; }

        /// &lt;summary&gt;
        ///     Создает &lt;see cref=&quot;Task&quot; /&gt; из полей шаблона путем рендеринга подстановок в строках.
        ///     Состояние подстановок обрабатывается последовательно.
        ///     &lt;para&gt;
        ///         Порядок рендеринга такой:
        ///         &lt;list type=&quot;bullet&quot;&gt;
        ///             &lt;see cref=&quot;Text&quot; /&gt;
        ///             &lt;see cref=&quot;Answer&quot; /&gt;
        ///             &lt;see cref=&quot;Question&quot; /&gt;
        ///             &lt;see cref=&quot;Hints&quot; /&gt;
        ///             &lt;see cref=&quot;PossibleAnswers&quot; /&gt;
        ///         &lt;/list&gt;
        ///     &lt;/para&gt;
        /// &lt;/summary&gt;
        public override Task GetTask(Random randomSeed)
        {
            var so = CreateScriptObject(randomSeed);

            var simpleFieldsStorage = Concat(Text, Answer, Question);
            var hintsStorage = Concat(Hints ?? new string[0]);
            var answersStorage = Concat(PossibleAnswers ?? new string[0]);

            var fields = new[] {simpleFieldsStorage, hintsStorage, answersStorage};

            var ((code, answer, question), hints, answers)
                = fields.MapMany(vs =&gt; Concat(vs).Map(s =&gt; Template.Parse(s).Render(so)).Split())
                    .Select(r =&gt; r.Split().ToArray())
                    .ToArray();
            return new Task(code, hints, answer, Id, answers, question);
        }

        public static ScriptObject CreateScriptObject(Random random)
        {
            return TemplateLanguage.Create(random);
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[22,13,22,29,1],[23,9,23,10,1],[24,13,24,117,1],[25,13,25,25,1],[26,13,26,87,1],[27,13,27,29,1],[28,13,28,33,1],[29,9,29,10,1],[31,57,31,61,1],[33,44,33,48,1],[35,48,35,52,1],[37,47,37,51,1],[43,32,43,36,1],[60,9,60,10,1],[61,13,61,53,1],[63,13,63,70,1],[64,13,64,63,1],[65,13,65,75,1],[67,13,67,84,1],[69,13,70,40,1],[70,40,70,60,1],[70,60,70,88,1],[70,88,70,97,1],[70,40,70,97,1],[70,97,71,34,1],[71,34,71,53,1],[71,53,72,32,1],[69,13,72,32,1],[73,13,73,73,1],[74,9,74,10,1],[77,9,77,10,1],[78,13,78,52,1],[79,9,79,10,1]]);
    </script>
  </body>
</html>