<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>e:\users\funfine\source\quiz\quiz\tests\applicationtests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using Application.Extensions;
using Application.QuizService;
using Application.Repositories;
using Application.Selectors;
using Domain.Entities;
using Domain.Entities.TaskGenerators;
using FluentAssertions;
using Microsoft.Extensions.Logging.Abstractions;
using NUnit.Framework;
using Tests.Mocks;

namespace Tests
{
    [TestFixture]
    public class ApplicationTests
    {
        [SetUp]
        public void SetUp()
        {
            userRepository = new TestUserRepository();
            taskRepository = new TestTaskRepository();
            selector = new TestTaskGeneratorSelector();
            
            application = new QuizService(userRepository, taskRepository, selector, NullLogger&lt;QuizService&gt;.Instance, new Random());
        }

        private IQuizService application;
        private IUserRepository userRepository;
        private ITaskRepository taskRepository;
        private ITaskGeneratorSelector selector;

        [Test]
        public void GetAvailableLevels_AddsNewUser_WhenNoUser()
        {
            var userId = Guid.NewGuid();
            var topicId = AddEmptyTopic();
            Assert.IsNull(userRepository.FindById(userId));
            application.GetAvailableLevels(userId, topicId);
            userRepository.FindById(userId).Should().NotBeNull();
        }

        [Test]
        public void GetAvailableLevels_ReturnsFailure_WhenNoTopics()
        {
            application
                .GetAvailableLevels(Guid.NewGuid(), Guid.NewGuid())
                .IsFailure
                .Should()
                .BeTrue();
        }

        [Test]
        public void GetAvailableLevels_ReturnsFirstLevel_WhenNoProgress()
        {
            var topicId = AddEmptyTopic();
            var ids = AddLevels(topicId);
            application
                .GetAvailableLevels(Guid.NewGuid(), topicId)
                .Value
                .First()
                .Id
                .Should()
                .Be(ids.First());
        }

        [Test]
        public void GetAvailableLevels_ReturnsSuccess_WhenNoLevels()
        {
            var id = AddEmptyTopic();
            application
                .GetAvailableLevels(Guid.NewGuid(), id)
                .IsSuccess
                .Should()
                .BeTrue();
        }

        [Test]
        public void GetAvailableLevels_ReturnsSuccess_WhenNoUsers()
        {
            var id = AddEmptyTopic();
            application
                .GetAvailableLevels(Guid.NewGuid(), id)
                .IsSuccess
                .Should()
                .BeTrue();
        }

        [Test]
        public void GetCurrentProgress_ReturnsFailure_WhenNoLevels()
        {
            var id = AddEmptyTopic();
            application
                .GetProgress(Guid.NewGuid(), id, Guid.NewGuid())
                .IsFailure
                .Should()
                .BeTrue();
        }

        [Test]
        public void GetCurrentProgress_ReturnsFailure_WhenNoTopics()
        {
            application
                .GetProgress(Guid.NewGuid(), Guid.NewGuid(), Guid.NewGuid())
                .IsFailure
                .Should()
                .BeTrue();
        }

        [Test]
        public void GetCurrentProgress_ReturnsSuccess_WhenNoUsers()
        {
            var (topicId, levelId) = AddTopicWithLevel();
            application
                .GetProgress(Guid.NewGuid(), topicId, levelId)
                .IsSuccess
                .Should()
                .BeTrue();
        }

        [Test]
        public void GetLevels_ReturnsAllLevels()
        {
            var topicId = AddEmptyTopic();
            var ids = AddLevels(topicId);
            application
                .GetLevels(topicId)
                .Value
                .Select(l =&gt; l.Id)
                .Should()
                .BeEquivalentTo(ids);
        }

        [Test]
        public void GetLevels_ReturnsFailure_WhenNoTopics()
        {
            application
                .GetLevels(Guid.NewGuid())
                .IsFailure
                .Should()
                .BeTrue();
        }

        [Test]
        public void GetLevels_ReturnsSuccess_WhenNoLevels()
        {
            var id = AddEmptyTopic();
            application
                .GetLevels(id)
                .IsSuccess
                .Should()
                .BeTrue();
        }

        [Test]
        public void GetTask_ReturnsFailure_WhenLevelNotAvailable()
        {
            var (topicId, _) = AddTopicWithLevel();
            var levelId = Guid.NewGuid();
            taskRepository.InsertLevel(topicId, CreateLevel(levelId));
            var user = userRepository.FindOrInsertUser(Guid.NewGuid(), taskRepository);
            application
                .GetTask(user.Id, topicId, levelId)
                .IsFailure
                .Should()
                .BeTrue();
        }

        [Test]
        public void GetTask_ReturnsFailure_WhenNoLevels()
        {
            var id = AddEmptyTopic();
            application
                .GetTask(Guid.NewGuid(), id, Guid.NewGuid())
                .IsFailure
                .Should()
                .BeTrue();
        }

        [Test]
        public void GetTask_ReturnsFailure_WhenNoTopics()
        {
            application.GetTask(Guid.NewGuid(), Guid.NewGuid(), Guid.NewGuid())
                .IsFailure
                .Should()
                .BeTrue();
        }

        [Test]
        public void GetTask_ReturnsSuccess_WhenNoGenerators()
        {
            var (topicId, levelId) = AddTopicWithLevel();
            application
                .GetTask(Guid.NewGuid(), topicId, levelId)
                .IsSuccess
                .Should()
                .BeTrue();
        }

        [Test]
        public void GetTask_ReturnsSuccess_WhenNoUsers()
        {
            var (topicId, levelId) = AddTopicWithLevel();
            application
                .GetTask(Guid.NewGuid(), topicId, levelId)
                .IsSuccess
                .Should()
                .BeTrue();
        }

        [Test]
        public void GetTopicsInfo_ReturnsAllTopics()
        {
            var ids = new List&lt;Guid&gt;();
            for (var i = 0; i &lt; 5; i++)
                ids.Add(AddEmptyTopic());
            application
                .GetTopicsInfo()
                .Value
                .Select(t =&gt; t.Id)
                .Should()
                .BeEquivalentTo(ids);
        }

        [Test]
        public void GetTopicsInfo_ReturnsSuccess_WhenNoTopics()
        {
            application
                .GetTopicsInfo()
                .IsSuccess
                .Should()
                .BeTrue();
        }

        private IEnumerable&lt;Guid&gt; AddLevels(Guid topicId)
        {
            var ids = new List&lt;Guid&gt;();
            for (var i = 0; i &lt; 5; i++)
                ids.Add(AddEmptyLevel(topicId));
            return ids;
        }

        private (Guid topicId, Guid levelId) AddTopicWithLevel()
        {
            var topicId = Guid.NewGuid();
            var levelId = Guid.NewGuid();
            var level = CreateLevel(levelId, new[] { new TestGenerator(42) });
            taskRepository.InsertTopic(new Topic(topicId, &quot;&quot;, &quot;&quot;, new[] { level }));
            return (topicId, levelId);
        }

        private Guid AddEmptyTopic()
        {
            var id = Guid.NewGuid();
            taskRepository.InsertTopic(new Topic(id, &quot;&quot;, &quot;&quot;, new Level[0]));
            return id;
        }

        private Guid AddEmptyLevel(Guid topicId) =&gt; taskRepository.InsertLevel(topicId, CreateLevel()).Id;

        private static Level CreateLevel(
            Guid id,
            IEnumerable&lt;TaskGenerator&gt; generators,
            IEnumerable&lt;Guid&gt; nextLevels)
        {
            return new Level(id, $&quot;{id}&quot;, generators.ToArray(), nextLevels.ToArray());
        }

        private static Level CreateLevel(Guid id, IEnumerable&lt;TaskGenerator&gt; generators) =&gt;
            CreateLevel(id, generators, new Guid[0]);

        private static Level CreateLevel(Guid id) =&gt; CreateLevel(id, new TaskGenerator[0]);

        private static Level CreateLevel() =&gt; CreateLevel(Guid.NewGuid());
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[22,9,22,10,1],[23,13,23,55,1],[24,13,24,55,1],[25,13,25,56,1],[27,13,27,133,1],[28,9,28,10,1],[37,9,37,10,1],[38,13,38,41,1],[39,13,39,43,1],[40,13,40,60,1],[41,13,41,61,1],[42,13,42,66,1],[43,9,43,10,1],[47,9,47,10,1],[48,13,52,27,1],[53,9,53,10,1],[57,9,57,10,1],[58,13,58,43,1],[59,13,59,42,1],[60,13,66,34,1],[67,9,67,10,1],[71,9,71,10,1],[72,13,72,38,1],[73,13,77,27,1],[78,9,78,10,1],[82,9,82,10,1],[83,13,83,38,1],[84,13,88,27,1],[89,9,89,10,1],[93,9,93,10,1],[94,13,94,38,1],[95,13,99,27,1],[100,9,100,10,1],[104,9,104,10,1],[105,13,109,27,1],[110,9,110,10,1],[114,9,114,10,1],[115,13,115,58,1],[116,13,120,27,1],[121,9,121,10,1],[125,9,125,10,1],[126,13,126,43,1],[127,13,127,42,1],[128,13,131,30,1],[131,30,131,34,1],[131,34,133,38,1],[128,13,133,38,1],[134,9,134,10,1],[138,9,138,10,1],[139,13,143,27,1],[144,9,144,10,1],[148,9,148,10,1],[149,13,149,38,1],[150,13,154,27,1],[155,9,155,10,1],[159,9,159,10,1],[160,13,160,52,1],[161,13,161,42,1],[162,13,162,71,1],[163,13,163,88,1],[164,13,168,27,1],[169,9,169,10,1],[173,9,173,10,1],[174,13,174,38,1],[175,13,179,27,1],[180,9,180,10,1],[184,9,184,10,1],[185,13,188,27,1],[189,9,189,10,1],[193,9,193,10,1],[194,13,194,58,1],[195,13,199,27,1],[200,9,200,10,1],[204,9,204,10,1],[205,13,205,58,1],[206,13,210,27,1],[211,9,211,10,1],[215,9,215,10,1],[216,13,216,40,1],[217,18,217,27,1],[217,29,217,34,1],[217,36,217,39,1],[218,17,218,42,1],[219,13,222,30,1],[222,30,222,34,1],[222,34,224,38,1],[219,13,224,38,1],[225,9,225,10,1],[229,9,229,10,1],[230,13,234,27,1],[235,9,235,10,1],[238,9,238,10,1],[239,13,239,40,1],[240,18,240,27,1],[240,29,240,34,1],[240,36,240,39,1],[241,17,241,49,1],[242,13,242,24,1],[243,9,243,10,1],[246,9,246,10,1],[247,13,247,42,1],[248,13,248,42,1],[249,13,249,79,1],[250,13,250,85,1],[251,13,251,39,1],[252,9,252,10,1],[255,9,255,10,1],[256,13,256,37,1],[257,13,257,77,1],[258,13,258,23,1],[259,9,259,10,1],[261,53,261,106,1],[267,9,267,10,1],[268,13,268,87,1],[269,9,269,10,1],[272,13,272,53,1],[274,54,274,91,1],[276,47,276,74,1]]);
    </script>
  </body>
</html>