<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>e:\users\funfine\source\quiz\quiz\tests\telegramstatemachinetests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using FakeItEasy;
using FluentAssertions;
using NUnit.Framework;
using QuizBotCore;
using QuizBotCore.Commands;
using QuizBotCore.Database;
using QuizBotCore.States;
using QuizBotCore.Transitions;
using QuizRequestService;
using QuizRequestService.DTO;

namespace Tests
{
    [TestFixture]
    public class TelegramStateMachineTests
    {
        private IQuizService quizService;
        private IUserRepository userRepository;
        private IStateMachine&lt;ICommand&gt; stateMachine;
        private TopicDTO testTopic;
        private LevelDTO testLevel;

        [SetUp]
        public void Setup()
        {
            quizService = A.Fake&lt;IQuizService&gt;();
            testTopic = new TopicDTO(Guid.NewGuid(), &quot;TestTopicName&quot;);
            testLevel = new LevelDTO(Guid.NewGuid(), &quot;TestLevelName&quot;);
            A.CallTo(() =&gt; quizService.GetTopics()).Returns(new[] { testTopic });
            A.CallTo(() =&gt; quizService.GetLevels(testTopic.Id)).Returns(new[] { testLevel });
            userRepository = A.Fake&lt;IUserRepository&gt;();
            stateMachine = new TelegramStateMachine(quizService, userRepository);
        }

        [Test]
        public void GetNextState_HelpTransition_ReturnTopicSelectionState()
        {
            var unknownUserState = new UnknownUserState();
            var helpTransition = new HelpTransition();
            var (state, command) = stateMachine.GetNextState(unknownUserState, helpTransition);
            state.Should().BeOfType&lt;TopicSelectionState&gt;();
            command.Should().BeOfType&lt;SelectTopicCommand&gt;();
        }

        [Test]
        public void GetNextState_FeedbackTransition_ReturnTopicSelectionState()
        {
            var unknownUserState = new UnknownUserState();
            var feedbackTransition = new FeedbackTransition();
            var (state, command) = stateMachine.GetNextState(unknownUserState, feedbackTransition);
            state.Should().BeOfType&lt;TopicSelectionState&gt;();
            command.Should().BeOfType&lt;FeedBackCommand&gt;();
        }

        [Test]
        public void GetNextState_UnknownState_ReturnTopicSelectionState()
        {
            var unknownUserState = new UnknownUserState();
            var backTransition = new BackTransition();
            var (state, command) = stateMachine.GetNextState(unknownUserState, backTransition);
            state.Should().BeOfType&lt;TopicSelectionState&gt;();
            command.Should().BeOfType&lt;SelectTopicCommand&gt;();
        }

        [Test]
        public void GetNextState_TopicSelectionState_OnBackTransition_ReturnTopicSelectionState()
        {
            var unknownUserState = new TopicSelectionState();
            var backTransition = new BackTransition();
            var (state, command) = stateMachine.GetNextState(unknownUserState, backTransition);
            state.Should().BeOfType&lt;TopicSelectionState&gt;();
            command.Should().BeOfType&lt;SelectTopicCommand&gt;();
        }

        [Test]
        public void GetNextState_TopicSelectionState_OnCorrectTransition_ReturnTopicSelectionState()
        {
            var unknownUserState = new TopicSelectionState();
            var backTransition = new CorrectTransition(testTopic.Id.ToString());
            var (state, command) = stateMachine.GetNextState(unknownUserState, backTransition);
            state.As&lt;LevelSelectionState&gt;()
                .TopicDto.Should()
                .Be(new LevelSelectionState(testTopic).TopicDto);
            command.Should().BeOfType&lt;SelectLevelCommand&gt;();
        }

        [Test]
        public void GetNextState_LevelSelectionState_OnBackTransition_ReturnTopicSelectionState()
        {
            var unknownUserState = new LevelSelectionState(testTopic);
            var backTransition = new BackTransition();
            var (state, command) = stateMachine.GetNextState(unknownUserState, backTransition);
            state.Should().BeOfType&lt;TopicSelectionState&gt;();
            command.Should().BeOfType&lt;SelectTopicCommand&gt;();
        }

        [Test]
        public void GetNextState_LevelSelectionState_OnCorrectTransition_ReturnTopicSelectionState()
        {
            var unknownUserState = new LevelSelectionState(testTopic);
            var backTransition = new CorrectTransition(testLevel.Id.ToString());
            var (state, command) = stateMachine.GetNextState(unknownUserState, backTransition);
            var taskState = state.As&lt;TaskState&gt;();
            taskState.TopicDto.Should().Be(testTopic);
            taskState.LevelDto.Should().Be(testLevel);
            command.Should().BeOfType&lt;ShowTaskCommand&gt;();
        }

        [Test]
        public void GetNextState_TaskState_OnBackTransition_ReturnLevelSelectionState()
        {
            var unknownUserState = new TaskState(testTopic, testLevel);
            var backTransition = new BackTransition();
            var (state, command) = stateMachine.GetNextState(unknownUserState, backTransition);
            var levelSelectionState = state.As&lt;LevelSelectionState&gt;();
            levelSelectionState.TopicDto.Should().Be(testTopic);
            command.Should().BeOfType&lt;SelectLevelCommand&gt;();
        }

        [Test]
        public void GetNextState_TaskState_OnShowHintTransition_ReturnShowHintCommandAndSaveState()
        {
            var unknownUserState = new TaskState(testTopic, testLevel);
            var backTransition = new ShowHintTransition();
            var (state, command) = stateMachine.GetNextState(unknownUserState, backTransition);
            var taskState = state.As&lt;TaskState&gt;();
            taskState.TopicDto.Should().Be(testTopic);
            taskState.LevelDto.Should().Be(testLevel);
            command.Should().BeOfType&lt;ShowHintCommand&gt;();
        }

        [Test]
        public void GetNextState_TaskState_OnCorrectTransition_ReturnCheckTaskCommandAndSaveState()
        {
            var unknownUserState = new TaskState(testTopic, testLevel);
            var backTransition = new CorrectTransition(&quot;answer&quot;);
            var (state, command) = stateMachine.GetNextState(unknownUserState, backTransition);
            var taskState = state.As&lt;TaskState&gt;();
            taskState.TopicDto.Should().Be(testTopic);
            taskState.LevelDto.Should().Be(testLevel);
            command.Should().BeOfType&lt;CheckTaskCommand&gt;();
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[26,9,26,10,1],[27,13,27,50,1],[28,13,28,71,1],[29,13,29,71,1],[30,13,30,82,1],[31,13,31,94,1],[32,13,32,56,1],[33,13,33,82,1],[34,9,34,10,1],[38,9,38,10,1],[39,13,39,59,1],[40,13,40,55,1],[41,13,41,96,1],[42,13,42,60,1],[43,13,43,61,1],[44,9,44,10,1],[48,9,48,10,1],[49,13,49,59,1],[50,13,50,63,1],[51,13,51,100,1],[52,13,52,60,1],[53,13,53,58,1],[54,9,54,10,1],[58,9,58,10,1],[59,13,59,59,1],[60,13,60,55,1],[61,13,61,96,1],[62,13,62,60,1],[63,13,63,61,1],[64,9,64,10,1],[68,9,68,10,1],[69,13,69,62,1],[70,13,70,55,1],[71,13,71,96,1],[72,13,72,60,1],[73,13,73,61,1],[74,9,74,10,1],[78,9,78,10,1],[79,13,79,62,1],[80,13,80,81,1],[81,13,81,96,1],[82,13,84,66,1],[85,13,85,61,1],[86,9,86,10,1],[90,9,90,10,1],[91,13,91,71,1],[92,13,92,55,1],[93,13,93,96,1],[94,13,94,60,1],[95,13,95,61,1],[96,9,96,10,1],[100,9,100,10,1],[101,13,101,71,1],[102,13,102,81,1],[103,13,103,96,1],[104,13,104,51,1],[105,13,105,55,1],[106,13,106,55,1],[107,13,107,58,1],[108,9,108,10,1],[112,9,112,10,1],[113,13,113,72,1],[114,13,114,55,1],[115,13,115,96,1],[116,13,116,71,1],[117,13,117,65,1],[118,13,118,61,1],[119,9,119,10,1],[123,9,123,10,1],[124,13,124,72,1],[125,13,125,59,1],[126,13,126,96,1],[127,13,127,51,1],[128,13,128,55,1],[129,13,129,55,1],[130,13,130,58,1],[131,9,131,10,1],[135,9,135,10,1],[136,13,136,72,1],[137,13,137,66,1],[138,13,138,96,1],[139,13,139,51,1],[140,13,140,55,1],[141,13,141,55,1],[142,13,142,59,1],[143,9,143,10,1]]);
    </script>
  </body>
</html>