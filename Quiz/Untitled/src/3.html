<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>e:\users\funfine\source\quiz\quiz\complexityweb\startup.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.IO;
using System.Linq;
using System.Reflection;
using Application.Info;
using Application.QuizService;
using Application.Repositories;
using Application.Selectors;
using Application.TaskService;
using AutoMapper;
using DataBase;
using Domain.Entities.TaskGenerators;
using Microsoft.AspNetCore.Builder;
using Microsoft.AspNetCore.Hosting;
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.DependencyInjection;
using QuizWebApp.Services.QuizService.DTO;
using QuizWebApp.Services.TaskService;
using QuizWebApp.Services.TaskService.DTO;
using Swashbuckle.AspNetCore.Swagger;

namespace QuizWebApp
{
    public class Startup
    {
        public const string MongoUsernameEnvironmentVariable = &quot;MONGO_USERNAME&quot;;
        public const string MongoPasswordEnvironmentVariable = &quot;MONGO_PASSWORD&quot;;
        public const string MongoDatabaseNameEnvironmentVariable = &quot;MONGO_DB_NAME&quot;;
        private const string MyAllowSpecificOrigins = &quot;_myAllowSpecificOrigins&quot;;

        public Startup(IConfiguration configuration)
        {
            Configuration = configuration;
        }

        public IConfiguration Configuration { get; }

        // This method gets called by the runtime. Use this method to add services to the container.
        public void ConfigureServices(IServiceCollection services)
        {
            services.AddRouting(options =&gt; options.LowercaseUrls = true);
            services.AddMvc(o =&gt; o.InputFormatters.Insert(0, new RawRequestBodyFormatter())).SetCompatibilityVersion(CompatibilityVersion.Version_2_2);

            services.AddTransient(_ =&gt; new Random(Guid.NewGuid().GetHashCode()));

            services.AddScoped&lt;IQuizService, QuizService&gt;();
            services.AddScoped&lt;ITaskService, TaskService&gt;();

            services.AddScoped&lt;IUserRepository, MongoUserRepository&gt;();
            services.AddScoped&lt;ITaskRepository, MongoTaskRepository&gt;();

            var databaseName = Environment.GetEnvironmentVariable(MongoDatabaseNameEnvironmentVariable);
            var username = Environment.GetEnvironmentVariable(MongoUsernameEnvironmentVariable);
            var password = Environment.GetEnvironmentVariable(MongoPasswordEnvironmentVariable);
            services.AddSingleton(MongoDatabaseInitializer.CreateMongoDatabase(databaseName, username, password));

            services.AddTransient&lt;RandomTaskGeneratorSelector&gt;();
            services.AddTransient&lt;ITaskGeneratorSelector, ProgressTaskGeneratorSelector&gt;(p =&gt;
                new ProgressTaskGeneratorSelector(p.GetService&lt;Random&gt;(), p.GetService&lt;RandomTaskGeneratorSelector&gt;()));

            services.AddSwaggerGen(c =&gt;
            {
                c.SwaggerDoc(&quot;v1&quot;,
                    new Info
                    {
                        Version = &quot;v1&quot;, Title = &quot;Complexity bot&quot;, Description = &quot;Web API of Complexity bot&quot;
                    });
                var xmlFile = $&quot;{Assembly.GetExecutingAssembly().GetName().Name}.xml&quot;;
                var xmlPath = Path.Combine(AppContext.BaseDirectory, xmlFile);
                c.IncludeXmlComments(xmlPath);
            });
        }

        // This method gets called by the runtime. Use this method to configure the HTTP request pipeline.
        public void Configure(IApplicationBuilder app, IHostingEnvironment env)
        {
            app.Use((context, next) =&gt;
            {
                if (context.Request.Headers.Any(k =&gt; k.Key.Contains(&quot;Origin&quot;)) &amp;&amp; context.Request.Method == &quot;OPTIONS&quot;)
                {
                    context.Response.StatusCode = 200;
                    return context.Response.WriteAsync(&quot;handled&quot;);
                }

                return next.Invoke();
            });
            if (env.IsDevelopment())
                app.UseDeveloperExceptionPage();
            else
                app.UseHsts();
            
            Mapper.Initialize(cfg =&gt;
            {
                cfg.CreateMap&lt;TaskInfo, TaskInfoDTO&gt;();
                cfg.CreateMap&lt;LevelInfo, LevelInfoDTO&gt;();
                cfg.CreateMap&lt;TopicInfo, TopicInfoDTO&gt;();
                cfg.CreateMap&lt;HintInfo, HintInfoDTO&gt;();
                cfg.CreateMap&lt;LevelProgressInfo, LevelProgressInfoDTO&gt;();
                cfg.CreateMap&lt;TemplateTaskGenerator, AdminTemplateGeneratorDTO&gt;();
            });

            app.UseSwagger();

            // Enable middleware to serve swagger-ui (HTML, JS, CSS, etc.), 
            // specifying the Swagger JSON endpoint.
            app.UseSwaggerUI(c =&gt;
            {
                c.SwaggerEndpoint(&quot;/swagger/v1/swagger.json&quot;, &quot;My API V1&quot;);
                c.RoutePrefix = &quot;swagger&quot;;
            });

            app.UseStaticFiles();
            app.UseMvc();
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[33,9,33,53,0],[34,9,34,10,0],[35,13,35,43,0],[36,9,36,10,0],[38,47,38,51,0],[42,9,42,10,0],[43,13,43,44,0],[43,44,43,72,0],[43,72,43,74,0],[43,13,43,74,0],[44,13,44,34,0],[44,34,44,92,0],[44,92,44,152,0],[44,13,44,152,0],[46,13,46,40,0],[46,40,46,80,0],[46,80,46,82,0],[46,13,46,82,0],[48,13,48,61,0],[49,13,49,61,0],[51,13,51,72,0],[52,13,52,72,0],[54,13,54,105,0],[55,13,55,97,0],[56,13,56,97,0],[57,13,57,115,0],[59,13,59,66,0],[60,13,61,17,0],[61,17,61,119,0],[61,119,61,121,0],[60,13,61,121,0],[63,13,64,13,0],[64,13,64,14,0],[64,14,65,17,0],[65,17,69,24,0],[69,24,70,17,0],[70,17,70,87,0],[70,87,71,17,0],[71,17,71,79,0],[71,79,72,17,0],[72,17,72,47,0],[72,47,73,13,0],[73,13,73,14,0],[73,14,73,16,0],[63,13,73,16,0],[74,9,74,10,0],[78,9,78,10,0],[79,13,80,13,0],[80,13,80,14,0],[80,14,81,17,0],[81,17,81,54,0],[81,54,81,78,0],[81,78,81,119,0],[81,17,81,119,0],[81,119,82,17,0],[82,17,82,18,0],[82,18,83,21,0],[83,21,83,55,0],[83,55,84,21,0],[84,21,84,67,0],[84,67,87,17,0],[87,17,87,38,0],[87,38,88,13,0],[88,13,88,14,0],[88,14,88,16,0],[79,13,88,16,0],[89,13,89,37,0],[90,17,90,49,0],[92,17,92,31,0],[94,13,95,13,0],[95,13,95,14,0],[95,14,96,17,0],[96,17,96,56,0],[96,56,97,17,0],[97,17,97,58,0],[97,58,98,17,0],[98,17,98,58,0],[98,58,99,17,0],[99,17,99,56,0],[99,56,100,17,0],[100,17,100,74,0],[100,74,101,17,0],[101,17,101,83,0],[101,83,102,13,0],[102,13,102,14,0],[102,14,102,16,0],[94,13,102,16,0],[104,13,104,30,0],[108,13,109,13,0],[109,13,109,14,0],[109,14,110,17,0],[110,17,110,76,0],[110,76,111,17,0],[111,17,111,43,0],[111,43,112,13,0],[112,13,112,14,0],[112,14,112,16,0],[108,13,112,16,0],[114,13,114,34,0],[115,13,115,26,0],[116,9,116,10,0]]);
    </script>
  </body>
</html>