<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>e:\users\funfine\source\quiz\quiz\quizbotcore\commands\checktaskcommand.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Threading.Tasks;
using QuizBotCore.Database;
using QuizRequestService.DTO;
using Telegram.Bot;
using Telegram.Bot.Types;
using Telegram.Bot.Types.ReplyMarkups;

namespace QuizBotCore.Commands
{
    public class CheckTaskCommand : ICommand
    {
        private readonly TopicDTO topicDto;
        private readonly LevelDTO levelDto;
        private readonly string answer;


        public CheckTaskCommand(TopicDTO topicDto, LevelDTO levelDto, string answer)
        {
            this.topicDto = topicDto;
            this.levelDto = levelDto;
            this.answer = answer;
            
        }

        public async Task ExecuteAsync(Chat chat, TelegramBotClient client, ServiceManager serviceManager)
        {
            var user = serviceManager.UserRepository.FindByTelegramId(chat.Id);
            var isCorrect = serviceManager.QuizService.SendAnswer(user.Id, answer);
            if (isCorrect.HasValue)
            {
                await RemoveButtonsForPreviousTask(user, chat, client);
                if (isCorrect.Value)
                {
                    await client.SendTextMessageAsync(chat.Id, serviceManager.Dialog.Messages.CorrectAnswer);
                    await new ShowTaskCommand(topicDto, levelDto, true).ExecuteAsync(chat, client, serviceManager);
                }
                else
                {
                    await client.SendTextMessageAsync(chat.Id, serviceManager.Dialog.Messages.WrongAnswer);
                    await new ShowTaskCommand(topicDto, levelDto).ExecuteAsync(chat, client, serviceManager);
                }
            }
        }

        private async Task RemoveButtonsForPreviousTask(UserEntity user, Chat chat, TelegramBotClient client)
        {
            var topicId = Convert.ToBase64String(topicDto.Id.ToByteArray());
            var levelId = Convert.ToBase64String(levelDto.Id.ToByteArray());
            var reportCallback = $&quot;{StringCallbacks.Report}\n{user.MessageId}\n{topicId}\n{levelId}&quot;;
            var reportButton = new[]
            {
                InlineKeyboardButton
                    .WithCallbackData(ButtonNames.Report, reportCallback)
            };
            await client.EditMessageReplyMarkupAsync(chat.Id, user.MessageId, reportButton);
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[18,9,18,85,1],[19,9,19,10,1],[20,13,20,38,1],[21,13,21,38,1],[22,13,22,34,1],[24,9,24,10,1],[27,9,27,10,0],[28,13,28,80,0],[29,13,29,84,0],[30,13,30,36,0],[31,13,31,14,0],[32,17,32,72,0],[33,17,33,37,0],[34,17,34,18,0],[35,21,35,110,0],[36,21,36,116,0],[37,17,37,18,0],[39,17,39,18,0],[40,21,40,108,0],[41,21,41,110,0],[42,17,42,18,0],[43,13,43,14,0],[44,9,44,10,0],[47,9,47,10,0],[48,13,48,77,0],[49,13,49,77,0],[50,13,50,102,0],[51,13,55,15,0],[56,13,56,93,0],[57,9,57,10,0]]);
    </script>
  </body>
</html>