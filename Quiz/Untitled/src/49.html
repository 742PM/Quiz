<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>e:\users\funfine\source\quiz\quiz\infrastructure\storage.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Diagnostics.Contracts;
using System.Linq;
using System.Text.RegularExpressions;
using Infrastructure.Extensions;
using static System.String;

namespace Infrastructure
{
    public sealed class Storage : IEquatable&lt;Storage&gt;
    {
        private Storage(ICollection&lt;string&gt; items)
        {
            if (items == null)
                throw new ArgumentException(&quot;Can not split null&quot;);
            Key = Guid.NewGuid().ToString();
            Count = items.Count - 1;
            Concatenated = items.Count == 0 ? &quot;&quot; : Join(Key, items);
        }

        private Storage(string value, string key, int count) =&gt; (Concatenated, Key, Count) = (value, key, count);

        private int Count { get; }

        private string Concatenated { get; }

        private string Key { get; }

        public bool Equals(Storage other) =&gt; Split().SequenceEqual(other.Split());

        public override bool Equals(object obj)
        {
            if (obj is null)
                return false;
            if (ReferenceEquals(this, obj))
                return true;
            if (obj is Storage storage)
                return Equals(storage);
            return false;
        }

        public override int GetHashCode()
        {
            unchecked
            {
                return ((Concatenated?.GetHashCode() ?? 0) * 397) ^ (Key?.GetHashCode() ?? 0);
            }
        }

        public static Storage Concat(params string[] items) =&gt; new Storage(items);

        [Pure]
        public string[] Split() =&gt; Concatenated?.Length == 0
                                       ? new string[0]
                                       : Concatenated?.Split(Key)?.ToArray() ?? new string[0];

        /// &lt;summary&gt;
        ///     Применяет функцию к &quot;склеенным&quot; в строку входным элементам.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;mapper&quot;&gt;
        ///     Функция, изменяющая элементы.
        ///     Функция не должна увеличивать вероятность разделителя (&lt;see cref=&quot;Guid&quot; /&gt;) попасть в элементы
        /// &lt;/param&gt;
        [Pure]
        public Storage Map(Func&lt;string, string&gt; mapper)
        {
            var mapped = mapper(Concatenated);
            var newKey = mapper(Key);
            var newCount = Regex.Matches(mapped, newKey).Count;
            if (newCount != Count)
                throw new ArgumentException($&quot;Your function {mapper.Method.Name} is breaking Storage law&quot;);
            return new Storage(mapped, newKey, Count);
        }

        public override string ToString() =&gt; $&quot;Contains {Join(&quot;, &quot;, Split())};&quot; +
                                             $&quot; {nameof(Count)}: {Count}, {nameof(Concatenated)}: {Concatenated}, {nameof(Key)}: {Key}&quot;;

        [Pure]
        public static Storage[] MapMany(Storage[] items, Func&lt;string[], string[]&gt; mapper) =&gt;
            items.Zip(mapper(items.Select(storage =&gt; storage.Concatenated)
                                  .ToArray()), mapper(items.Select(storage =&gt; storage.Key).ToArray()),
                      (storage, mappedValue, mappedKey) =&gt; new Storage(mappedValue, mappedKey, storage.Count))
                 .ToArray();
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[13,9,13,51,1],[14,9,14,10,1],[15,13,15,31,1],[16,17,16,67,1],[17,13,17,45,1],[18,13,18,37,1],[19,13,19,69,1],[20,9,20,10,1],[22,9,22,61,1],[22,65,22,113,1],[24,29,24,33,1],[26,39,26,43,1],[28,30,28,34,1],[30,46,30,82,1],[33,9,33,10,1],[34,13,34,29,1],[35,17,35,30,0],[36,13,36,44,1],[37,17,37,29,0],[38,13,38,40,1],[39,17,39,40,1],[40,13,40,26,0],[41,9,41,10,1],[44,9,44,10,0],[46,13,46,14,0],[47,17,47,95,0],[49,9,49,10,0],[51,64,51,82,1],[54,36,56,94,1],[67,9,67,10,1],[68,13,68,47,1],[69,13,69,38,1],[70,13,70,64,1],[71,13,71,35,1],[72,17,72,108,1],[73,13,73,55,1],[74,9,74,10,1],[76,46,77,136,0],[81,13,81,54,1],[81,54,81,74,1],[81,74,82,79,1],[82,79,82,90,1],[82,90,83,60,1],[83,60,83,110,1],[83,110,84,28,1],[81,13,84,28,1]]);
    </script>
  </body>
</html>