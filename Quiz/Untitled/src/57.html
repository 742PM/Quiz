<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>e:\users\funfine\source\quiz\quiz\infrastructure\result\result.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Diagnostics;
using System.Linq;
using System.Runtime.Serialization;
using System.Threading.Tasks;

namespace Infrastructure.Result
{
    internal sealed class ResultCommonLogic : ResultCommonLogic&lt;string&gt;
    {
        private ResultCommonLogic(bool isFailure, string error) : base(isFailure, error)
        {
        }

        [DebuggerStepThrough]
        public static ResultCommonLogic Create(bool isFailure, string error)
        {
            if (isFailure)
            {
                if (string.IsNullOrEmpty(error))
                    throw new ArgumentNullException(nameof(error), ResultMessages.ErrorMessageIsNotProvidedForFailure);
            }
            else
            {
                if (error != null)
                    throw new ArgumentException(ResultMessages.ErrorMessageIsProvidedForSuccess, nameof(error));
            }

            return new ResultCommonLogic(isFailure, error);
        }
    }

    public struct Result : IResult, ISerializable
    {
        private static readonly Result OkResult = new Result(false, null);

        public static string ErrorMessagesSeparator = &quot;, &quot;;
        public static bool DefaultConfigureAwait = false;

        void ISerializable.GetObjectData(SerializationInfo info, StreamingContext context)
        {
            _logic.GetObjectData(info, context);
        }

        [DebuggerBrowsable(DebuggerBrowsableState.Never)]
        private readonly ResultCommonLogic _logic;

        public bool IsFailure =&gt; _logic.IsFailure;
        public bool IsSuccess =&gt; _logic.IsSuccess;
        public string Error =&gt; _logic.Error;

        [DebuggerStepThrough]
        private Result(bool isFailure, string error)
        {
            _logic = ResultCommonLogic.Create(isFailure, error);
        }

        [DebuggerStepThrough]
        public static Result Ok() =&gt; OkResult;

        [DebuggerStepThrough]
        public static Result Fail(string error) =&gt; new Result(true, error);

        [DebuggerStepThrough]
        public static Result Create(bool isSuccess, string error) =&gt; isSuccess ? Ok() : Fail(error);

        public static Result Create(Func&lt;bool&gt; predicate, string error) =&gt; Create(predicate(), error);

        public static async Task&lt;Result&gt; Create(Func&lt;Task&lt;bool&gt;&gt; predicate, string error)
        {
            var isSuccess = await predicate()
                                .ConfigureAwait(DefaultConfigureAwait);
            return Create(isSuccess, error);
        }

        [DebuggerStepThrough]
        public static Result&lt;T&gt; Ok&lt;T&gt;(T value) =&gt; new Result&lt;T&gt;(false, value, null);

        [DebuggerStepThrough]
        public static Result&lt;T&gt; Fail&lt;T&gt;(string error) =&gt; new Result&lt;T&gt;(true, default, error);

        public static Result&lt;T&gt; Create&lt;T&gt;(bool isSuccess, T value, string error) =&gt;
            isSuccess ? Ok(value) : Fail&lt;T&gt;(error);

        public static Result&lt;T&gt; Create&lt;T&gt;(Func&lt;bool&gt; predicate, T value, string error) =&gt;
            Create(predicate(), value, error);

        public static async Task&lt;Result&lt;T&gt;&gt; Create&lt;T&gt;(Func&lt;Task&lt;bool&gt;&gt; predicate, T value, string error)
        {
            var isSuccess = await predicate()
                                .ConfigureAwait(DefaultConfigureAwait);
            return Create(isSuccess, value, error);
        }

        [DebuggerStepThrough]
        public static Result&lt;T, E&gt; Ok&lt;T, E&gt;(T value) where E:Exception=&gt; new Result&lt;T, E&gt;(false, value, default) ;

        [DebuggerStepThrough]
        public static Result&lt;T, E&gt; Fail&lt;T, E&gt;(E error) where E : Exception =&gt; new Result&lt;T, E&gt;(true, default, error);

        [DebuggerStepThrough]
        public static Result&lt;T, E&gt; Create&lt;T, E&gt;(bool isSuccess, T value, E error) where E : Exception =&gt;
            isSuccess ? Ok&lt;T, E&gt;(value) : Fail&lt;T, E&gt;(error);

        public static Result&lt;T, E&gt; Create&lt;T, E&gt;(Func&lt;bool&gt; predicate, T value, E error) where E : Exception =&gt;
            predicate() ? Ok&lt;T, E&gt;(value) : Fail&lt;T, E&gt;(error);

        public static async Task&lt;Result&lt;T, E&gt;&gt; Create&lt;T, E&gt;(Func&lt;Task&lt;bool&gt;&gt; predicate, T value, E error) where E : Exception
        {
            var isSuccess = await predicate()
                                .ConfigureAwait(DefaultConfigureAwait);
            return isSuccess ? Ok&lt;T, E&gt;(value) : Fail&lt;T, E&gt;(error);
        }

        /// &lt;summary&gt;
        ///     Returns first failure in the list of &lt;paramref name=&quot;results&quot; /&gt;. If there is no failure returns success.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;results&quot;&gt;List of results.&lt;/param&gt;
        [DebuggerStepThrough]
        public static Result FirstFailureOrSuccess(params Result[] results)
        {
            foreach (var result in results)
                if (result.IsFailure)
                    return Fail(result.Error);

            return Ok();
        }

        /// &lt;summary&gt;
        ///     Returns failure which combined from all failures in the &lt;paramref name=&quot;results&quot; /&gt; list. Error messages are
        ///     separated by &lt;paramref name=&quot;errorMessagesSeparator&quot; /&gt;.
        ///     If there is no failure returns success.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;errorMessagesSeparator&quot;&gt;Separator for error messages.&lt;/param&gt;
        /// &lt;param name=&quot;results&quot;&gt;List of results.&lt;/param&gt;
        [DebuggerStepThrough]
        public static Result Combine(string errorMessagesSeparator, params Result[] results)
        {
            var failedResults = results.Where(x =&gt; x.IsFailure)
                                       .ToList();

            if (failedResults.Count == 0)
                return Ok();

            var errorMessage = string.Join(errorMessagesSeparator, failedResults.Select(x =&gt; x.Error)
                                                                                .ToArray());
            return Fail(errorMessage);
        }

        [DebuggerStepThrough]
        public static Result Combine(params Result[] results) =&gt; Combine(ErrorMessagesSeparator, results);

        [DebuggerStepThrough]
        public static Result Combine&lt;T&gt;(params Result&lt;T&gt;[] results) =&gt; Combine(ErrorMessagesSeparator, results);

        [DebuggerStepThrough]
        public static Result Combine&lt;T&gt;(string errorMessagesSeparator, params Result&lt;T&gt;[] results)
        {
            var untyped = results.Select(result =&gt; (Result) result)
                                 .ToArray();
            return Combine(errorMessagesSeparator, untyped);
        }

        private static readonly Func&lt;Exception, string&gt; DefaultTryErrorHandler = exc =&gt; exc.Message;

        public static Result Try(Action action, Func&lt;Exception, string&gt; errorHandler = null)
        {
            errorHandler = errorHandler ?? DefaultTryErrorHandler;

            try
            {
                action();
                return Ok();
            }
            catch (Exception exc)
            {
                var message = errorHandler(exc);
                return Fail(message);
            }
        }

        public static Result&lt;T&gt; Try&lt;T&gt;(Func&lt;T&gt; func, Func&lt;Exception, string&gt; errorHandler = null)
        {
            errorHandler = errorHandler ?? DefaultTryErrorHandler;

            try
            {
                return Ok(func());
            }
            catch (Exception exc)
            {
                var message = errorHandler(exc);
                return Fail&lt;T&gt;(message);
            }
        }

        public static async Task&lt;Result&lt;T&gt;&gt; Try&lt;T&gt;(Func&lt;Task&lt;T&gt;&gt; func, Func&lt;Exception, string&gt; errorHandler = null)
        {
            errorHandler = errorHandler ?? DefaultTryErrorHandler;

            try
            {
                var result = await func()
                                 .ConfigureAwait(DefaultConfigureAwait);
                return Ok(result);
            }
            catch (Exception exc)
            {
                var message = errorHandler(exc);
                return Fail&lt;T&gt;(message);
            }
        }

        public static Result&lt;T, E&gt; Try&lt;T, E&gt;(Func&lt;T&gt; func, Func&lt;Exception, E&gt; errorHandler) where E :  Exception
        {
            try
            {
                return Ok&lt;T, E&gt;(func());
            }
            catch (Exception exc)
            {
                var error = errorHandler(exc);
                return Fail&lt;T, E&gt;(error);
            }
        }

        public static async Task&lt;Result&lt;T, E&gt;&gt; Try&lt;T, E&gt;(Func&lt;Task&lt;T&gt;&gt; func, Func&lt;Exception, E&gt; errorHandler)
            where E :  Exception
        {
            try
            {
                var result = await func()
                                 .ConfigureAwait(DefaultConfigureAwait);
                return Ok&lt;T, E&gt;(result);
            }
            catch (Exception exc)
            {
                var error = errorHandler(exc);
                return Fail&lt;T, E&gt;(error);
            }
        }

        public void Deconstruct(out bool isSuccess, out bool isFailure)
        {
            isSuccess = IsSuccess;
            isFailure = IsFailure;
        }

        public void Deconstruct(out bool isSuccess, out bool isFailure, out string error)
        {
            isSuccess = IsSuccess;
            isFailure = IsFailure;
            error = IsFailure ? Error : null;
        }
    }

    public struct Result&lt;T&gt; : IResult, ISerializable
    {
        [DebuggerBrowsable(DebuggerBrowsableState.Never)]
        private readonly ResultCommonLogic _logic;

        public bool IsFailure =&gt; _logic.IsFailure;
        public bool IsSuccess =&gt; _logic.IsSuccess;
        public string Error =&gt; _logic.Error;

        public static implicit operator Result&lt;T&gt;(T value) =&gt; Result.Ok(value);

        void ISerializable.GetObjectData(SerializationInfo info, StreamingContext context)
        {
            _logic.GetObjectData(info, context);

            if (IsSuccess) info.AddValue(&quot;Value&quot;, Value);
        }

        [DebuggerBrowsable(DebuggerBrowsableState.Never)]
        private readonly T _value;

        public T Value
        {
            [DebuggerStepThrough]
            get
            {
                if (!IsSuccess)
                    throw new ResultFailureException(Error);

                return _value;
            }
        }

        [DebuggerStepThrough]
        internal Result(bool isFailure, T value, string error)
        {
            _logic = ResultCommonLogic.Create(isFailure, error);
            _value = value;
        }

        public static implicit operator Result(Result&lt;T&gt; result)
        {
            if (result.IsSuccess)
                return Result.Ok();
            return Result.Fail(result.Error);
        }

        public void Deconstruct(out bool isSuccess, out bool isFailure)
        {
            isSuccess = IsSuccess;
            isFailure = IsFailure;
        }

        public void Deconstruct(out bool isSuccess, out bool isFailure, out T value)
        {
            isSuccess = IsSuccess;
            isFailure = IsFailure;
            value = IsSuccess ? Value : default;
        }

        public void Deconstruct(out bool isSuccess, out bool isFailure, out T value, out string error)
        {
            isSuccess = IsSuccess;
            isFailure = IsFailure;
            value = IsSuccess ? Value : default;
            error = IsFailure ? Error : null;
        }
    }

    public struct Result&lt;T, TError
            &gt; : IResult, ISerializable where TError
             : Exception
    {
        [DebuggerBrowsable(DebuggerBrowsableState.Never)]
        private readonly ResultCommonLogic&lt;TError
            &gt; _logic;

        public bool IsFailure =&gt; _logic.IsFailure;
        public bool IsSuccess =&gt; _logic.IsSuccess;
        public TError
             Error =&gt; _logic.Error;
        public static implicit operator Result&lt;T, TError
            &gt;(T value) =&gt; Result.Ok&lt;T, TError
            &gt;(value);
        public static implicit operator Result&lt;T, TError
            &gt;(TError
             error) =&gt; Result.Fail&lt;T, TError
            &gt;(error);

        // public static implicit operator Result&lt;T, E&gt;(Result&lt;T&gt; value) =&gt; value.IsSuccess ? (Result&lt;T, E&gt;) value.Value : default(E);

        void ISerializable.GetObjectData(SerializationInfo info, StreamingContext context)
        {
            _logic.GetObjectData(info, context);

            if (IsSuccess) info.AddValue(&quot;Value&quot;, Value);
        }

        public Result&lt;TOut,TError
            &gt; Then&lt;TOut&gt;(Func&lt;T,TOut&gt; f)
        {
            if (IsSuccess)
                return f(Value);
            return Error;
        }
        public Result&lt;TOut,Exception&gt; Then&lt;TOut&gt;(Func&lt;T, Result&lt;TOut,Exception&gt;&gt; f)
        {
            if (IsSuccess)
                return f(Value);
            return Error;
        }

        [DebuggerBrowsable(DebuggerBrowsableState.Never)]
        private readonly T _value;

        public T Value
        {
            [DebuggerStepThrough]
            get
            {
                if (!IsSuccess)
                    throw new ResultFailureException&lt;TError
            &gt;(Error);

                return _value;
            }
        }

        [DebuggerStepThrough]
        internal Result(bool isFailure, T value, TError
             error)
        {
            _logic = new ResultCommonLogic&lt;TError
            &gt;(isFailure, error);
            _value = value;
        }

        public static implicit operator Result(Result&lt;T, TError
            &gt; result)
        {
            if (result.IsSuccess)
                return Result.Ok();
            return Result.Fail(result.Error.ToString());
        }

        public static implicit operator Result&lt;T&gt;(Result&lt;T, TError
            &gt; result)
        {
            if (result.IsSuccess)
                return Result.Ok(result.Value);
            return Result.Fail&lt;T&gt;(result.Error.ToString());
        }

        public void Deconstruct(out bool isSuccess, out bool isFailure)
        {
            isSuccess = IsSuccess;
            isFailure = IsFailure;
        }

        public void Deconstruct(out bool isSuccess, out bool isFailure, out T value)
        {
            isSuccess = IsSuccess;
            isFailure = IsFailure;
            value = IsSuccess ? Value : default;
        }

        public void Deconstruct(out bool isSuccess, out bool isFailure, out T value, out TError
             error)
        {
            isSuccess = IsSuccess;
            isFailure = IsFailure;
            value = IsSuccess ? Value : default;
            error = IsFailure ? Error : default;
        }

    }

    
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[11,67,11,89,0],[12,9,12,10,0],[13,9,13,10,0],[17,9,17,10,0],[18,13,18,27,0],[19,13,19,14,0],[20,17,20,49,0],[21,21,21,120,0],[22,13,22,14,0],[24,13,24,14,0],[25,17,25,35,0],[26,21,26,113,0],[27,13,27,14,0],[29,13,29,60,0],[30,9,30,10,0],[35,9,35,75,0],[37,9,37,60,0],[38,9,38,58,0],[41,9,41,10,0],[42,13,42,49,0],[43,9,43,10,0],[48,34,48,50,0],[49,34,49,50,0],[50,32,50,44,0],[54,9,54,10,0],[55,13,55,65,0],[56,9,56,10,0],[59,38,59,46,0],[62,52,62,75,0],[65,70,65,100,0],[67,76,67,102,0],[70,9,70,10,0],[71,13,72,72,0],[73,13,73,45,0],[74,9,74,10,0],[77,51,77,84,0],[80,58,80,93,0],[83,13,83,51,0],[86,13,86,46,0],[89,9,89,10,0],[90,13,91,72,0],[92,13,92,52,0],[93,9,93,10,0],[96,74,96,113,1],[99,79,99,117,1],[103,13,103,60,0],[106,13,106,62,0],[109,9,109,10,0],[110,13,111,72,0],[112,13,112,68,0],[113,9,113,10,0],[121,9,121,10,0],[122,13,122,20,0],[122,22,122,32,0],[122,33,122,35,0],[122,36,122,43,0],[123,17,123,38,0],[124,21,124,47,0],[126,13,126,25,0],[127,9,127,10,0],[138,9,138,10,0],[139,13,139,52,0],[139,52,139,63,0],[139,63,140,50,0],[139,13,140,50,0],[142,13,142,42,0],[143,17,143,29,0],[145,13,145,94,0],[145,94,145,101,0],[145,101,146,93,0],[145,13,146,93,0],[147,13,147,39,0],[148,9,148,10,0],[151,66,151,106,0],[154,72,154,112,0],[158,9,158,10,0],[159,13,159,52,0],[159,52,159,67,0],[159,67,160,45,0],[159,13,160,45,0],[161,13,161,61,0],[162,9,162,10,0],[164,9,164,89,0],[164,89,164,100,0],[164,100,164,101,0],[164,9,164,101,0],[167,9,167,10,0],[168,13,168,67,0],[171,13,171,14,0],[172,17,172,26,0],[173,17,173,29,0],[175,13,175,34,0],[176,13,176,14,0],[177,17,177,49,0],[178,17,178,38,0],[180,9,180,10,0],[183,9,183,10,0],[184,13,184,67,0],[187,13,187,14,0],[188,17,188,35,0],[190,13,190,34,0],[191,13,191,14,0],[192,17,192,49,0],[193,17,193,41,0],[195,9,195,10,0],[198,9,198,10,0],[199,13,199,67,0],[202,13,202,14,0],[203,17,204,73,0],[205,17,205,35,0],[207,13,207,34,0],[208,13,208,14,0],[209,17,209,49,0],[210,17,210,41,0],[212,9,212,10,0],[215,9,215,10,0],[217,13,217,14,0],[218,17,218,41,0],[220,13,220,34,0],[221,13,221,14,0],[222,17,222,47,0],[223,17,223,42,0],[225,9,225,10,0],[229,9,229,10,0],[231,13,231,14,0],[232,17,233,73,0],[234,17,234,41,0],[236,13,236,34,0],[237,13,237,14,0],[238,17,238,47,0],[239,17,239,42,0],[241,9,241,10,0],[244,9,244,10,0],[245,13,245,35,0],[246,13,246,35,0],[247,9,247,10,0],[250,9,250,10,0],[251,13,251,35,0],[252,13,252,35,0],[253,13,253,46,0],[254,9,254,10,0],[262,34,262,50,0],[263,34,263,50,0],[264,32,264,44,0],[266,63,266,79,0],[269,9,269,10,0],[270,13,270,49,0],[272,13,272,27,0],[272,28,272,58,0],[273,9,273,10,0],[282,13,282,14,0],[283,17,283,32,0],[284,21,284,61,0],[286,17,286,31,0],[287,13,287,14,0],[292,9,292,10,0],[293,13,293,65,0],[294,13,294,28,0],[295,9,295,10,0],[298,9,298,10,0],[299,13,299,34,0],[300,17,300,36,0],[301,13,301,46,0],[302,9,302,10,0],[305,9,305,10,0],[306,13,306,35,0],[307,13,307,35,0],[308,9,308,10,0],[311,9,311,10,0],[312,13,312,35,0],[313,13,313,35,0],[314,13,314,49,0],[315,9,315,10,0],[318,9,318,10,0],[319,13,319,35,0],[320,13,320,35,0],[321,13,321,49,0],[322,13,322,46,0],[323,9,323,10,0],[334,34,334,50,1],[335,34,335,50,1],[337,23,337,35,0],[339,27,340,21,1],[343,24,344,21,1],[349,9,349,10,0],[350,13,350,49,0],[352,13,352,27,0],[352,28,352,58,0],[353,9,353,10,0],[357,9,357,10,0],[358,13,358,27,0],[359,17,359,33,0],[360,13,360,26,0],[361,9,361,10,0],[363,9,363,10,0],[364,13,364,27,0],[365,17,365,33,0],[366,13,366,26,0],[367,9,367,10,0],[376,13,376,14,1],[377,17,377,32,1],[378,21,379,22,0],[381,17,381,31,1],[382,13,382,14,1],[388,9,388,10,1],[389,13,390,33,1],[391,13,391,28,1],[392,9,392,10,1],[396,9,396,10,0],[397,13,397,34,0],[398,17,398,36,0],[399,13,399,57,0],[400,9,400,10,0],[404,9,404,10,0],[405,13,405,34,0],[406,17,406,48,0],[407,13,407,60,0],[408,9,408,10,0],[411,9,411,10,0],[412,13,412,35,0],[413,13,413,35,0],[414,9,414,10,0],[417,9,417,10,0],[418,13,418,35,0],[419,13,419,35,0],[420,13,420,49,0],[421,9,421,10,0],[425,9,425,10,1],[426,13,426,35,1],[427,13,427,35,1],[428,13,428,49,1],[429,13,429,49,1],[430,9,430,10,1]]);
    </script>
  </body>
</html>