<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>e:\users\funfine\source\quiz\quiz\application\quizservice\quizservice.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using Application.Exceptions;
using Application.Extensions;
using Application.Info;
using Application.Repositories;
using Application.Repositories.Entities;
using Application.Selectors;
using Domain.Values;
using Infrastructure.Extensions;
using Infrastructure.Result;
using Microsoft.Extensions.Logging;

namespace Application.QuizService
{
    public class QuizService : IQuizService
    {
        private readonly ITaskGeneratorSelector generatorSelector;
        private readonly Random random;

        private readonly ITaskRepository taskRepository;

        private readonly IUserRepository userRepository;

        public QuizService(
            IUserRepository userRepository,
            ITaskRepository taskRepository,
            ITaskGeneratorSelector generatorSelector,
            ILogger&lt;QuizService&gt; logger,
            Random random)
        {
            this.userRepository = userRepository;
            this.taskRepository = taskRepository;
            this.generatorSelector = generatorSelector;
            this.random = random;
            Logger = logger;
            this.random = random;
        }

        private ILogger&lt;QuizService&gt; Logger { get; }

        /// &lt;inheritdoc /&gt;
        public Result&lt;IEnumerable&lt;TopicInfo&gt;, Exception&gt; GetTopicsInfo()
        {
            Logger.LogInformation(&quot;Showing topics;&quot;);

            return taskRepository
                .GetTopics()
                .Select(topic =&gt; topic.ToInfo())
                .LogInfo(ts =&gt; $&quot;Found {ts.Count()} topics&quot;, Logger)
                .Ok();
        }

        /// &lt;inheritdoc /&gt;
        public Result&lt;IEnumerable&lt;LevelInfo&gt;, Exception&gt; GetLevels(Guid topicId)
        {
            Logger.LogInformation($&quot;Getting levels for topic {topicId}&quot;);

            if (taskRepository.TopicExists(topicId))
                return taskRepository
                    .GetLevelsFromTopic(topicId)
                    .Select(level =&gt; level.ToInfo())
                    .LogInfo(levels =&gt; $&quot;Found {levels.Count()} levels&quot;, Logger)
                    .Ok();

            Logger.LogError($&quot;Did not find any levels for {topicId}&quot;);
            return new ArgumentException(nameof(topicId));
        }

        /// &lt;inheritdoc /&gt;
        public Result&lt;IEnumerable&lt;LevelInfo&gt;, Exception&gt; GetAvailableLevels(Guid userId, Guid topicId)
        {
            Logger.LogInformation($&quot;Showing Available levels for User @ {userId} at Topic @ {topicId}&quot;);

            var user = userRepository.FindOrInsertUser(userId, taskRepository);

            if (!taskRepository.TopicExists(topicId))
                return new ArgumentException(nameof(topicId));

            userRepository.UpdateUserProgress(taskRepository, user);
            userRepository.UpdateTopicProgress(taskRepository, user, topicId);

            return user
                .UserProgressEntity
                .TopicsProgress[topicId]
                .LogInfo(topicProgress =&gt; $&quot;Found TopicProgressEntity {topicProgress}&quot;, Logger)
                .LevelProgressEntities
                .Select(pair =&gt; taskRepository.FindLevel(topicId, pair.Key)?.ToInfo())
                .Where(level =&gt; level != null)
                .LogInfo(s =&gt; $&quot;Found {s.Count()} levels&quot;, Logger)
                .Ok();
        }

        /// &lt;inheritdoc /&gt;
        public Result&lt;LevelProgressInfo, Exception&gt; GetProgress(Guid userId, Guid topicId, Guid levelId)
        {
            if (!taskRepository.TopicExists(topicId))
                return new ArgumentException(nameof(topicId));
            if (!taskRepository.LevelExists(topicId, levelId))
                return new ArgumentException(nameof(levelId));

            var user = userRepository.FindOrInsertUser(userId, taskRepository);

            userRepository.UpdateUserProgress(taskRepository, user);
            userRepository.UpdateTopicProgress(taskRepository, user, topicId);
            userRepository.UpdateLevelProgress(taskRepository, user, topicId, levelId);

            var levelsProgress = user
                .UserProgressEntity
                .TopicsProgress[topicId]
                .LevelProgressEntities;

            if (!levelsProgress.ContainsKey(levelId))
                return new AccessDeniedException(
                    $&quot;User {userId} doesn&#39;t have access to level {levelId} in topic {topicId}&quot;);

            return GetLevelProgress(user, topicId, levelId);
        }

        /// &lt;inheritdoc /&gt;
        public Result&lt;TaskInfo, Exception&gt; GetTask(Guid userId, Guid topicId, Guid levelId)
        {
            if (!taskRepository.TopicExists(topicId))
                return new ArgumentException(nameof(topicId))
                    .LogError(_ =&gt;
                            $&quot;No topics exists for {(nameof(userId), userId, nameof(topicId), topicId, nameof(levelId), levelId)}&quot;,
                        Logger);
            if (!taskRepository.LevelExists(topicId, levelId))
                return new ArgumentException(nameof(levelId));

            var user = userRepository.FindOrInsertUser(userId, taskRepository);
            var levels = GetAvailableLevels(userId, topicId).Value;

            if (!levels.Select(info =&gt; info.Id).Contains(levelId))
                return new
                    AccessDeniedException($&quot;User {userId} doesn&#39;t have access to level {levelId} in topic {topicId}&quot;);

            userRepository.UpdateLevelProgress(taskRepository, user, topicId, levelId);

            var streaks = user
                .UserProgressEntity
                .TopicsProgress[topicId]
                .LevelProgressEntities[levelId]
                .CurrentLevelStreaks;

            var (_, isFailure, generator, error) = generatorSelector
                .SelectGenerator(taskRepository
                    .GetGeneratorsFromLevel(topicId, levelId), streaks);

            if (isFailure)
                return error;

            var task = generator.GetTask(random);
            UpdateUserCurrentTask(user, topicId, levelId, task);
            return task.ToInfo();
        }

        /// &lt;inheritdoc /&gt;
        public Result&lt;TaskInfo, Exception&gt; GetNextTask(Guid userId)
        {
            var user = userRepository.FindOrInsertUser(userId, taskRepository);

            if (!user.HasCurrentTask())
                return new AccessDeniedException($&quot;User {userId} hadn&#39;t started any task&quot;);

            return GetTask(userId, user.UserProgressEntity.CurrentTopicId, user.UserProgressEntity.CurrentLevelId);
        }

        /// &lt;inheritdoc /&gt;
        public Result&lt;bool, Exception&gt; CheckAnswer(Guid userId, string answer)
        {
            var user = userRepository.FindOrInsertUser(userId, taskRepository);
            Logger.LogInformation($&quot;Checking answer for User {user}: his answer is {answer}&quot;);
            if (!user.HasCurrentTask())
                return new AccessDeniedException($&quot;User {userId} hadn&#39;t started any task&quot;);

            var userUserProgress = user.UserProgressEntity;
            var currentTask = userUserProgress.CurrentTask;
            Logger.LogInformation($&quot;User&#39;s current task is {currentTask}&quot;);

            if (currentTask.IsSolved)
                return new AccessDeniedException(&quot;User&#39;s current task is solved already&quot;);

            if (currentTask.Answer != answer)
            {
                user = GetUserWithNewStreakIfNotSolved(user, _ =&gt; 0);
                userRepository.Update(user);
                return false;
            }

            user = user.With(
                userUserProgress.With(
                    currentTask: currentTask.With(isSolved: true)));
            user = GetUserWithNewStreakIfNotSolved(user, streak =&gt; streak + 1);
            user = GetUserWithNewProgressIfLevelSolved(user);
            userRepository.Update(user);
            return true;
        }

        /// &lt;inheritdoc /&gt;
        public Result&lt;HintInfo, Exception&gt; GetHint(Guid userId)
        {
            var user = userRepository.FindOrInsertUser(userId, taskRepository);

            if (!user.HasCurrentTask())
                return new AccessDeniedException($&quot;User {userId} had not started any task&quot;);

            var userProgress = user.UserProgressEntity;
            var currentTask = userProgress.CurrentTask;
            var hints = currentTask.Hints;
            var currentHintIndex = currentTask.HintsTaken;

            if (currentHintIndex &gt;= hints.Length)
                return new OutOfHintsException(&quot;Out of hints&quot;);

            user = user.With(userProgress.With(currentTask: currentTask.With(hintsTaken: currentTask.HintsTaken + 1)));
            userRepository.Update(user);
            return new HintInfo(hints[currentHintIndex], currentHintIndex &lt; hints.Length - 1);
        }

        private UserEntity GetUserWithNewProgressIfLevelSolved(UserEntity user)
        {
            var topicId = user.UserProgressEntity.CurrentTopicId;
            var levelId = user.UserProgressEntity.CurrentLevelId;
            var progress = GetLevelProgress(user, topicId, levelId);
            if (progress.TasksSolved &lt; progress.TasksCount)
                return user;

            taskRepository
                .FindLevel(topicId, levelId)
                .NextLevels
                .Select(id =&gt; taskRepository.FindLevel(topicId, id))
                .ToList()
                .ForEach(level =&gt; user
                    .UserProgressEntity
                    .TopicsProgress[topicId]
                    .LevelProgressEntities
                    .TryAdd(level.Id, level.ToProgressEntity()));

            return user;
        }

        private bool IsGeneratorSolved(UserEntity user, Guid topicId, Guid levelId, Guid generatorId)
        {
            var currentStreak = user.GetCurrentStreak(topicId, levelId, generatorId);
            var streakToSolve = taskRepository.FindGenerator(topicId, levelId, generatorId).Streak;
            return currentStreak &gt;= streakToSolve;
        }

        private void UpdateUserCurrentTask(UserEntity user, Guid topicId, Guid levelId, Task task)
        {
            var taskInfoEntity = task.AsInfoEntity();
            var progress = user
                .UserProgressEntity
                .With(topicId, levelId, currentTask: taskInfoEntity);
            user = user.With(progress);
            userRepository.Update(user);
        }

        private UserEntity GetUserWithNewStreakIfNotSolved(UserEntity user, Func&lt;int, int&gt; updateFunc)
        {
            var topicId = user.UserProgressEntity.CurrentTopicId;
            var levelId = user.UserProgressEntity.CurrentLevelId;
            var generatorId = user.UserProgressEntity.CurrentTask.ParentGeneratorId;
            var currentStreak = user.GetCurrentStreak();
            if (!IsGeneratorSolved(user, topicId, levelId, generatorId))
                user.UserProgressEntity
                    .TopicsProgress[topicId]
                    .LevelProgressEntities[levelId]
                    .CurrentLevelStreaks[generatorId] = updateFunc(currentStreak);
            return user;
        }

        private LevelProgressInfo GetLevelProgress(UserEntity user, Guid topicId, Guid levelId)
        {
            var streaks = user
                .UserProgressEntity
                .TopicsProgress[topicId]
                .LevelProgressEntities[levelId]
                .CurrentLevelStreaks;

            var solved = streaks.Sum(pair =&gt; pair.Value);
            var total = streaks.Sum(pair =&gt; taskRepository.FindGenerator(topicId, levelId, pair.Key).Streak);
            return new LevelProgressInfo(total, solved);
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[26,9,31,27,1],[32,9,32,10,1],[33,13,33,50,1],[34,13,34,50,1],[35,13,35,56,1],[36,13,36,34,1],[37,13,37,29,1],[38,13,38,34,1],[39,9,39,10,1],[41,47,41,51,1],[45,9,45,10,1],[46,13,46,54,1],[48,13,50,34,1],[50,34,50,48,1],[50,48,51,32,1],[51,32,51,60,1],[51,60,52,23,1],[48,13,52,23,1],[53,9,53,10,1],[57,9,57,10,1],[58,13,58,74,1],[60,13,60,53,1],[61,17,63,38,1],[63,38,63,52,1],[63,52,64,40,1],[64,40,64,72,1],[64,72,65,27,1],[61,17,65,27,1],[67,13,67,71,1],[68,13,68,59,1],[69,9,69,10,1],[73,9,73,10,1],[74,13,74,105,1],[76,13,76,80,1],[78,13,78,54,1],[79,17,79,63,1],[81,13,81,69,1],[82,13,82,79,1],[84,13,87,43,1],[87,43,87,87,1],[87,87,89,33,1],[89,33,89,86,1],[89,86,90,33,1],[90,33,90,46,1],[90,46,91,31,1],[91,31,91,58,1],[91,58,92,23,1],[84,13,92,23,1],[93,9,93,10,1],[97,9,97,10,1],[98,13,98,54,1],[99,17,99,63,1],[100,13,100,63,1],[101,17,101,63,1],[103,13,103,80,1],[105,13,105,69,1],[106,13,106,79,1],[107,13,107,88,1],[109,13,112,40,1],[114,13,114,54,1],[115,17,116,97,0],[118,13,118,61,1],[119,9,119,10,1],[123,9,123,10,1],[124,13,124,54,1],[125,17,127,29,1],[127,29,127,131,1],[127,131,128,33,1],[125,17,128,33,1],[129,13,129,63,1],[130,17,130,63,1],[132,13,132,80,1],[133,13,133,68,1],[135,13,135,40,1],[135,40,135,47,1],[135,47,135,67,1],[135,13,135,67,1],[136,17,137,119,1],[139,13,139,88,1],[141,13,145,38,1],[147,13,149,73,1],[151,13,151,27,1],[152,17,152,30,0],[154,13,154,50,1],[155,13,155,65,1],[156,13,156,34,1],[157,9,157,10,1],[161,9,161,10,0],[162,13,162,80,0],[164,13,164,40,0],[165,17,165,92,0],[167,13,167,116,0],[168,9,168,10,0],[172,9,172,10,0],[173,13,173,80,0],[174,13,174,95,0],[175,13,175,40,0],[176,17,176,92,0],[178,13,178,60,0],[179,13,179,60,0],[180,13,180,76,0],[182,13,182,38,0],[183,17,183,91,0],[185,13,185,46,0],[186,13,186,14,0],[187,17,187,67,0],[187,67,187,68,0],[187,68,187,70,0],[187,17,187,70,0],[188,17,188,45,0],[189,17,189,30,0],[192,13,194,69,0],[195,13,195,68,0],[195,68,195,78,0],[195,78,195,80,0],[195,13,195,80,0],[196,13,196,62,0],[197,13,197,41,0],[198,13,198,25,0],[199,9,199,10,0],[203,9,203,10,0],[204,13,204,80,0],[206,13,206,40,0],[207,17,207,93,0],[209,13,209,56,0],[210,13,210,56,0],[211,13,211,43,0],[212,13,212,59,0],[214,13,214,50,0],[215,17,215,64,0],[217,13,217,120,0],[218,13,218,41,0],[219,13,219,95,0],[220,9,220,10,0],[223,9,223,10,0],[224,13,224,66,0],[225,13,225,66,0],[226,13,226,69,0],[227,13,227,60,0],[228,17,228,29,0],[230,13,233,31,0],[233,31,233,68,0],[233,68,235,35,0],[235,35,239,64,0],[239,64,239,66,0],[230,13,239,66,0],[241,13,241,25,0],[242,9,242,10,0],[245,9,245,10,0],[246,13,246,86,0],[247,13,247,100,0],[248,13,248,51,0],[249,9,249,10,0],[252,9,252,10,1],[253,13,253,54,1],[254,13,256,70,1],[257,13,257,40,1],[258,13,258,41,1],[259,9,259,10,1],[262,9,262,10,0],[263,13,263,66,0],[264,13,264,66,0],[265,13,265,85,0],[266,13,266,57,0],[267,13,267,73,0],[268,17,271,83,0],[272,13,272,25,0],[273,9,273,10,0],[276,9,276,10,1],[277,13,281,38,1],[283,13,283,46,1],[283,46,283,56,1],[283,56,283,58,1],[283,13,283,58,1],[284,13,284,45,1],[284,45,284,108,1],[284,108,284,110,1],[284,13,284,110,1],[285,13,285,57,1],[286,9,286,10,1]]);
    </script>
  </body>
</html>