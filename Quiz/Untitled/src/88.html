<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>e:\users\funfine\source\quiz\quiz\application\extensions\databaseextensions.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using Application.Repositories;
using Application.Repositories.Entities;
using Infrastructure.Extensions;

namespace Application.Extensions
{
    public static class DataBaseExtensions
    {
        public static UserEntity FindOrInsertUser(
            this IUserRepository userRepository,
            Guid userId,
            ITaskRepository taskRepository)
        {
            var progress = new UserProgressEntity(
                Guid.NewGuid(),
                Guid.NewGuid(),
                userId,
                id: Guid.NewGuid(),
                currentTask: null,
                topicsProgress: taskRepository
                    .GetTopics()
                    .SafeToDictionary(
                        topic =&gt; topic.Id,
                        topic =&gt; topic.ToProgressEntity()));

            return userRepository.FindById(userId) ?? userRepository.Insert(new UserEntity(userId, progress));
        }

        public static int GetCurrentStreak(
            this UserEntity user,
            Guid? topicId = null,
            Guid? levelId = null,
            Guid? generatorId = null)
        {
            var progress = user.UserProgressEntity;
            return progress
                .TopicsProgress[topicId ?? progress.CurrentTopicId]
                .LevelProgressEntities[levelId ?? progress.CurrentLevelId]
                .CurrentLevelStreaks[generatorId ?? progress.CurrentTask.ParentGeneratorId];
        }

        public static bool TopicExists(this ITaskRepository taskRepository, Guid topicId) =&gt;
            taskRepository.FindTopic(topicId) != null;

        public static bool LevelExists(this ITaskRepository taskRepository, Guid topicId, Guid levelId) =&gt;
            taskRepository.FindLevel(topicId, levelId) != null;

        public static bool GeneratorExists(
            this ITaskRepository taskRepository,
            Guid topicId,
            Guid levelId,
            Guid generatorId)
        {
            return taskRepository.FindGenerator(topicId, levelId, generatorId) != null;
        }

        public static UserProgressEntity GetRelevantUserProgress(
            this UserProgressEntity userProgress,
            ITaskRepository taskRepository)
        {
            var topics = taskRepository.GetTopics();
            foreach (var topic in topics)
                userProgress.TopicsProgress.TryAdd(topic.Id, topic.ToProgressEntity());

            var ids = topics.Select(topic =&gt; topic.Id);
            var progress = userProgress
                .TopicsProgress
                .TakeFrom(ids);

            return userProgress.With(topicsProgress: progress);
        }

        public static TopicProgressEntity GetRelevantTopicProgress(
            this TopicProgressEntity topicProgress,
            ITaskRepository taskRepository)
        {
            var levels = taskRepository.GetLevelsFromTopic(topicProgress.TopicId);
            if (levels.Length == 0)
                return topicProgress.With(new Dictionary&lt;Guid, LevelProgressEntity&gt;());

            var firstLevel = levels[0];

            topicProgress
                .LevelProgressEntities
                .TryAdd(firstLevel.Id, firstLevel.ToProgressEntity());

            var ids = levels.Select(level =&gt; level.Id);
            var progress = topicProgress
                .LevelProgressEntities
                .TakeFrom(ids);

            return topicProgress.With(progress);
        }

        public static LevelProgressEntity GetRelevantLevelProgress(
            this LevelProgressEntity levelProgress,
            Guid topicId,
            ITaskRepository taskRepository)
        {
            var level = taskRepository.FindLevel(topicId, levelProgress.LevelId);
            if (level is null)
                return levelProgress;

            foreach (var generator in level.Generators)
                levelProgress.CurrentLevelStreaks.TryAdd(generator.Id, 0);

            var ids = level.Generators.Select(generator =&gt; generator.Id);
            var streaks = levelProgress
                .CurrentLevelStreaks
                .TakeFrom(ids);

            return levelProgress.With(streaks);
        }

        public static void UpdateUserProgress(
            this IUserRepository userRepository,
            ITaskRepository taskRepository,
            UserEntity user)
        {
            var progress = user.UserProgressEntity.GetRelevantUserProgress(taskRepository);

            userRepository.Update(user.With(progress));
        }

        public static void UpdateTopicProgress(
            this IUserRepository userRepository,
            ITaskRepository taskRepository,
            UserEntity user,
            Guid topicId)
        {
            var topicsProgress = user.UserProgressEntity.TopicsProgress;

            if (!topicsProgress.ContainsKey(topicId))
                return;

            var progress = topicsProgress[topicId]
                .GetRelevantTopicProgress(taskRepository);

            topicsProgress[topicId] = progress;

            userRepository.Update(user);
        }

        public static void UpdateLevelProgress(
            this IUserRepository userRepository,
            ITaskRepository taskRepository,
            UserEntity user,
            Guid topicId,
            Guid levelId)
        {
            var topicsProgress = user.UserProgressEntity.TopicsProgress;

            if (!topicsProgress.ContainsKey(topicId) ||
                !topicsProgress[topicId].LevelProgressEntities.ContainsKey(levelId))
                return;

            var progress = topicsProgress[topicId]
                .LevelProgressEntities[levelId]
                .GetRelevantLevelProgress(topicId, taskRepository);

            topicsProgress[topicId]
                .LevelProgressEntities[levelId] = progress;

            userRepository.Update(user);
        }

        public static bool HasCurrentTask(this UserEntity user) =&gt; user.UserProgressEntity.CurrentTask != null;
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[16,9,16,10,1],[17,13,26,34,1],[26,34,26,42,1],[26,42,27,34,1],[27,34,27,58,1],[27,58,27,61,1],[17,13,27,61,1],[29,13,29,111,1],[30,9,30,10,1],[37,9,37,10,0],[38,13,38,52,0],[39,13,42,93,0],[43,9,43,10,0],[46,13,46,54,1],[49,13,49,63,1],[56,9,56,10,0],[57,13,57,88,0],[58,9,58,10,0],[63,9,63,10,1],[64,13,64,53,1],[65,13,65,20,1],[65,22,65,31,1],[65,32,65,34,1],[65,35,65,41,1],[66,17,66,88,1],[68,13,68,46,1],[68,46,68,54,1],[68,54,68,56,1],[68,13,68,56,1],[69,13,71,32,1],[73,13,73,64,1],[74,9,74,10,1],[79,9,79,10,1],[80,13,80,83,1],[81,13,81,36,1],[82,17,82,88,1],[84,13,84,40,1],[86,13,88,71,1],[90,13,90,46,1],[90,46,90,54,1],[90,54,90,56,1],[90,13,90,56,1],[91,13,93,32,1],[95,13,95,49,1],[96,9,96,10,1],[102,9,102,10,1],[103,13,103,82,1],[104,13,104,31,1],[105,17,105,38,0],[107,13,107,20,1],[107,22,107,35,1],[107,36,107,38,1],[107,39,107,55,1],[108,17,108,75,1],[110,13,110,60,1],[110,60,110,72,1],[110,72,110,74,1],[110,13,110,74,1],[111,13,113,32,1],[115,13,115,48,1],[116,9,116,10,1],[122,9,122,10,1],[123,13,123,92,1],[125,13,125,56,1],[126,9,126,10,1],[133,9,133,10,1],[134,13,134,73,1],[136,13,136,54,1],[137,17,137,24,0],[139,13,140,59,1],[142,13,142,48,1],[144,13,144,41,1],[145,9,145,10,1],[153,9,153,10,1],[154,13,154,73,1],[156,13,157,85,1],[158,17,158,24,0],[160,13,162,68,1],[164,13,165,60,1],[167,13,167,41,1],[168,9,168,10,1],[170,68,170,111,0]]);
    </script>
  </body>
</html>